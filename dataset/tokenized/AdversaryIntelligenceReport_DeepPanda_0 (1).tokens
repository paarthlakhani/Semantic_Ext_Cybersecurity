In IN O
late JJ O
December NNP O
2011 CD O
, , O
CrowdStrike NNP O
, , O
Inc. NNP O
received VBD O
three CD O
binary JJ O
executable JJ O
files NNS O
that WDT O
were VBD O
suspected VBN O
of IN O
having VBG O
been VBN O
involved VBN O
in IN O
a DT O
sophisticted JJ O
attack NN O
against IN O
a DT O
large JJ O
Fortune NN O
500 CD O
company NN O
. . O

The DT O
files NNS O
were VBD O
analyzed VBN O
to TO O
understand VB O
first RB O
if IN O
they PRP O
were VBD O
in IN O
fact NN O
malicious JJ O
, , O
and CC O
the DT O
level NN O
of IN O
sophistication NN O
of IN O
the DT O
samples NNS O
. . O

The DT O
samples NNS O
were VBD O
clearly RB O
malicious JJ O
and CC O
varied JJ O
in IN O
sophistication NN O
. . O

All DT B-Entity
three CD I-Entity
samples NNS I-Entity
provided VBD B-Action
remote JJ B-Entity
access NN I-Entity
to TO B-Modifier
the DT B-Entity
attacker NN I-Entity
, , O
via IN B-Modifier
two CD B-Entity
Command NN I-Entity
and CC I-Entity
Control NN I-Entity
( NN I-Entity
C2 NN I-Entity
) NN I-Entity
servers NNS I-Entity
. . O

One CD B-Entity
sample NN I-Entity
is VBZ O
typical JJ O
of IN O
what WP O
is VBZ O
commonly RB O
referred VBN O
to TO O
as IN O
a DT O
'dropper NN O
' '' O
because IN O
its PRP$ O
primary JJ O
purpose NN O
is VBZ O
to TO O
write VB B-Action
a DT B-Entity
malicious JJ I-Entity
component NN I-Entity
to TO B-Modifier
disk NN B-Entity
and CC O
connect VB O
it PRP O
to TO O
the DT O
targeted VBN O
hosts NNS O
operating VBG O
system NN O
. . O

The DT O
malicious JJ O
component NN O
in IN O
this DT O
case NN O
is VBZ O
what WP O
is VBZ O
commonly RB O
referred VBN O
to TO O
as IN O
a DT O
Remote JJ O
Access NN O
Tool NNP O
( NNP O
RAT NNP O
) NNP O
, , O
this DT O
RAT NN O
is VBZ O
manifested VBN O
as IN O
a DT B-Entity
Dynamic NNP I-Entity
Link NNP I-Entity
Library NNP I-Entity
( FW I-Entity
DLL FW I-Entity
) FW I-Entity
installed VBN B-Action
as IN B-Modifier
a DT B-Entity
service NN I-Entity
. . O

The DT O
second JJ O
sample NN O
analyzed VBN O
is VBZ O
a DT O
dual JJ O
use NN O
tool NN O
that WDT O
can MD O
function VB O
both DT O
as IN O
a DT B-Entity
post NN I-Entity
exploitation NN I-Entity
tool NN I-Entity
used VBN O
to TO O
infect VB B-Action
other JJ B-Entity
systems NNS I-Entity
, , O
download VB B-Action
additional JJ B-Entity
tools NNS I-Entity
, , O
remove VB B-Action
log NN B-Entity
data NNS I-Entity
, , O
and CC O
itself PRP B-Entity
be VB B-Action
used VBN I-Action
as IN B-Modifier
a DT B-Entity
backdoor NN I-Entity
. . O

The DT B-Entity
third JJ I-Entity
sample NN I-Entity
was VBD O
a DT O
sophisticated JJ O
implant VBP O
that IN O
in IN O
addition NN O
to TO O
having VBG B-Action
multiple JJ B-Entity
communication NN I-Entity
capabilities NNS I-Entity
, , O
and CC O
the DT O
ability NN O
to TO O
act VB B-Action
as IN B-Modifier
a DT B-Entity
relay NN I-Entity
for IN I-Entity
other JJ I-Entity
infected JJ I-Entity
hosts NNS I-Entity
, , O
utilized VBD B-Action
a DT B-Entity
kernel NN I-Entity
mode NN I-Entity
driver NN I-Entity
that WDT O
can MD O
hide VB B-Action
aspects NNS B-Entity
of IN I-Entity
the DT I-Entity
tool NN I-Entity
from IN B-Modifier
user-mode JJ B-Entity
tools NNS I-Entity
. . O

This DT B-Entity
third JJ I-Entity
component NN I-Entity
is VBZ B-Action
likely RB I-Action
used VBN I-Action
for IN B-Modifier
long-term JJ O
implantation NN O
and CC O
intelligence NN B-Entity
gathering NN I-Entity
. . O

Some DT O
AV NNP O
engines NNS O
occasionally RB O
identify VBP O
this DT O
sample NN O
as IN O
Derusbi NNP O
Trojan NNP O
. . O

CrowdStrike NNP O
Intelligence NNP O
Team NNP O
has VBZ O
seen VBN O
Trojans NNPS O
from IN O
8 CD O
different JJ O
builder NN O
variants NNS O
of IN O
this DT O
RAT NN O
, , O
including VBG O
64-bit JJ O
versions NNS O
, , O
used VBN O
in IN O
targeted VBN O
attacks NNS O
in IN O
2011 CD O
against IN O
Defense NNP O
, , O
Energy/Power NNP O
, , O
and CC O
Chemical NNP O
Industries NNPS O
in IN O
US NNP O
and CC O
Japan NNP O
. . O

All DT O
of IN O
these DT O
samples NNS O
reflect VBP O
common JJ O
toolmarks NNS O
and CC O
tradecraft NN O
consistent JJ O
with IN O
Chinese JJ O
based JJ O
actors NNS O
who WP O
target VBP O
various JJ O
strategic JJ O
interests NNS O
of IN O
the DT O
United NNP O
States NNPS O
including VBG O
High NNP O
Tech/Heavy NNP O
Industry NNP O
, , O
Non-Governmental NNP O
Organizations NNP O
( NNP O
NGOs NNP O
) NNP O
, , O
State/Federal NNP O
Government NNP O
, , O
Defense NNP O
Industrial NNP O
Base NNP O
( NNP O
DIB NNP O
) NNP O
, , O
and CC O
organizations NNS O
with IN O
vast JJ O
economic JJ O
interests NNS O
. . O

This DT O
report NN O
contains VBZ O
an DT O
in-depth JJ O
technical JJ O
analysis NN O
of IN O
the DT O
samples NNS O
, , O
detection/remediation/mitigation NN O
information NN O
, , O
attribution NN O
intelligence NN O
, , O
and CC O
a DT O
conclusion NN O
aimed VBN O
at IN O
providing VBG O
the DT O
reader NN O
with IN O
a DT O
synopsis NN O
of IN O
the DT O
report NN O
. . O

The DT B-Entity
executable JJ I-Entity
14c04f88dc97aef3e9b516ef208a2bf5 NN I-Entity
is VBZ O
commonly RB O
referred VBN O
to TO O
as IN O
a DT O
'dropper NN O
' '' O
, , O
which WDT O
is VBZ O
designed VBN O
with IN O
the DT O
purpose NN O
of IN O
extracting VBG B-Action
from IN B-Modifier
itself PRP B-Entity
a DT B-Entity
malicious JJ I-Entity
payload NN I-Entity
and CC O
to TO O
initialize VB B-Action
and CC I-Action
install VB I-Action
it PRP B-Entity
into IN B-Modifier
a DT B-Entity
targeted VBN I-Entity
system NN I-Entity
. . O

In IN O
this DT O
case NN O
, , O
the DT B-Entity
malicious JJ I-Entity
payload NN I-Entity
is VBZ O
a DT O
Dynamic-Link NNP O
Library NNP O
( NNP O
DLL NNP O
) NNP O
, , O
which WDT O
enables VBZ B-Action
an DT B-Entity
attacker NN I-Entity
to TO B-Modifier
have VB B-Entity
full JJ I-Entity
control NN I-Entity
of IN I-Entity
the DT I-Entity
system NN I-Entity
. . O

This DT O
code NN O
appears VBZ O
to TO O
have VB O
been VBN O
compiled VBN O
on IN O
Wednesday NNP O
May NNP O
4th JJ O
, , O
2011 CD O
at IN O
11:04:24 CD O
A.M. NNP O
UTC NNP O
( NN O
equivalent JJ O
to TO O
early JJ O
evening NN O
time NN O
in IN O
China NNP O
) NNP O
. . O

Note VB O
that IN O
the DT O
timestamp NN O
is VBZ O
in IN O
UTC NNP O
, , O
however RB O
the DT O
relative JJ O
time NN O
of IN O
day NN O
in IN O
China NNP O
is VBZ O
provided VBN O
for IN O
the DT O
benefit NN O
of IN O
the DT O
reader NN O
. . O

The DT B-Entity
sample NN I-Entity
first RB O
resolves VBZ B-Action
several JJ B-Entity
library NN I-Entity
functions NNS I-Entity
provided VBN I-Entity
by IN I-Entity
Microsoft NNP I-Entity
using VBG B-Modifier
the DT B-Entity
LoadLibrary NNP I-Entity
( NNP I-Entity
) NNP I-Entity
and CC I-Entity
GetProcAddress NNP I-Entity
( NNP I-Entity
) NNP I-Entity
Application NN I-Entity
Programming NNP I-Entity
Interfaces NNPS I-Entity
( FW I-Entity
APIs FW I-Entity
) FW I-Entity
. . O

The DT O
imported VBN O
function NN O
names NNS O
are VBP O
not RB O
encrypted VBN O
; : O
however RB O
, , O
the DT O
function NN O
name NN O
is VBZ O
minutely RB O
obfuscated VBN O
by IN O
a DT O
simple JJ O
single JJ O
character NN O
substitution NN O
: : O
The DT B-Entity
dropper NN I-Entity
invokes VBZ B-Action
the DT B-Entity
SHGetSpecialFolderPath NN I-Entity
( FW I-Entity
) FW I-Entity
API NN I-Entity
supplying VBG O
a DT O
Constant JJ O
Special JJ O
Item NN O
ID NN O
List NN O
( FW O
CSIDL FW O
) NN O
of IN O
'CSIDLCOMMONDOCUMENTS NN O
' '' O
to TO O
identify VB O
the DT O
destination NN O
folder NN O
for IN O
the DT O
malicious JJ O
DLL NNP O
payload NN O
. . O

The DT O
CSIDL NN O
in IN O
this DT O
case NN O
pints NNS O
to TO O
: : O
'' '' O
The DT O
file NN O
system NN O
directory NN O
that WDT O
contains VBZ O
documents NNS O
that WDT O
are VBP O
common JJ O
to TO O
all DT O
users NNS O
. . O

A DT O
typical JJ O
path NN O
is VBZ O
C NN O
: : O
\Documents NNS O
and CC O
Settings\All FW O
Users\Documents FW O
. . O

'' '' O
The DT B-Entity
dropper NN I-Entity
attempts VBZ O
to TO O
write VB B-Action
the DT B-Entity
malicious JJ I-Entity
payload NN I-Entity
to TO B-Modifier
one CD B-Entity
of IN I-Entity
the DT I-Entity
following JJ I-Entity
names NNS I-Entity
, , O
using VBG B-Modifier
the DT B-Entity
first JJ I-Entity
available JJ I-Entity
name NN I-Entity
in IN I-Entity
this DT I-Entity
set NN I-Entity
: : O
The DT B-Entity
dropper NN I-Entity
sets VBZ B-Action
the DT B-Entity
creation NN I-Entity
and CC I-Entity
last JJ I-Entity
written JJ I-Entity
timestamp NN I-Entity
of IN I-Entity
the DT I-Entity
newly RB I-Entity
created VBN I-Entity
file NN I-Entity
to TO B-Modifier
the DT B-Entity
date NN I-Entity
2007-03-07 CD I-Entity
00:00:00 CD I-Entity
; : O
this DT O
allows VBZ O
the DT B-Entity
newly RB I-Entity
created VBN I-Entity
malicious JJ I-Entity
DLL NNP I-Entity
to TO O
blend VB B-Action
in RP I-Action
with IN B-Modifier
other JJ B-Entity
system NN I-Entity
files NNS I-Entity
. . O

This DT B-Entity
is VBZ O
meant VBN O
to TO O
prevent VB B-Action
identification NN B-Entity
during IN B-Modifier
disk NN B-Entity
forensics NNS I-Entity
using VBG O
a DT O
common JJ O
investigative JJ O
technique NN O
called VBD O
a DT O
forensic JJ O
analysis NN O
timeline NN O
. . O

This DT O
date NN O
is VBZ O
specified VBN O
in IN O
the DT O
dropper NN O
code NN O
and CC O
does VBZ O
not RB O
change VB O
across IN O
multiple JJ O
infections NNS O
. . O

The DT B-Entity
malicious JJ I-Entity
DLL NNP I-Entity
file NN I-Entity
that WDT I-Entity
is VBZ I-Entity
dropped VBN I-Entity
is VBZ B-Action
hidden VBN I-Action
in IN B-Modifier
a DT B-Entity
resource NN I-Entity
of IN I-Entity
the DT I-Entity
dropper NN I-Entity
binary JJ I-Entity
. . O

This DT O
is VBZ O
a DT O
relatively RB O
common JJ O
technique NN O
used VBN O
by IN O
malware NN O
dropper NN O
files NNS O
to TO O
optimize VB O
the DT O
number NN O
of IN O
files NNS O
required VBN O
to TO O
infect VB O
a DT O
machine NN O
. . O

The DT O
resource NN O
language NN O
of IN O
the DT O
malicious JJ O
DLL NNP O
is VBZ O
set VBN O
to TO O
'' '' O
Chinese NNP O
( NNP O
Simplified NNP O
) NNP O
'' '' O
, , O
this DT O
is VBZ O
a DT O
compiler NN O
artifact NN O
which WDT O
indicates VBZ O
the DT O
language NN O
setting VBG O
on IN O
the DT O
compiler NN O
used VBN O
by IN O
the DT O
person NN O
who WP O
built VBD O
the DT O
binary JJ O
was VBD O
set VBN O
to TO O
'' '' O
Chinese NNP O
( NNP O
Simplified NNP O
) NNP O
'' '' O
at IN O
the DT O
time NN O
the DT O
dropper NN O
was VBD O
compiled VBN O
. . O

The DT O
'MZ NN O
' POS O
header NN O
which WDT O
denotes VBZ O
a DT O
binary JJ O
executable JJ O
file NN O
of IN O
the DT O
dropped VBN O
DLL NNP O
is VBZ O
initially RB O
obfuscated VBN O
. . O

When WRB O
the DT B-Entity
dropper NN I-Entity
writes VBZ B-Action
the DT B-Entity
file NN I-Entity
to TO B-Modifier
disk NN B-Entity
, , O
the DT B-Entity
first JJ I-Entity
byte NN I-Entity
of IN I-Entity
the DT I-Entity
file NN I-Entity
is VBZ I-Entity
'Z NN I-Entity
' '' I-Entity
which WDT O
prevents VBZ B-Action
the DT B-Entity
file NN I-Entity
from IN B-Modifier
executing VBG O
or CC O
being VBG B-Entity
detected VBN I-Entity
as IN I-Entity
an DT I-Entity
executable JJ I-Entity
by IN I-Entity
many JJ I-Entity
defensive JJ I-Entity
tools NNS I-Entity
. . O

The DT B-Entity
dropper NN I-Entity
subsequently RB O
opens VBZ B-Action
the DT B-Entity
dropped VBN I-Entity
file NN I-Entity
and CC O
corrects VBZ B-Action
the DT B-Entity
header NN I-Entity
by IN B-Modifier
writing VBG B-Entity
the DT I-Entity
'M VBP I-Entity
' '' I-Entity
over IN I-Entity
the DT I-Entity
first JJ I-Entity
byte NN I-Entity
, , O
allowing VBG O
the DT O
file NN O
to TO O
be VB O
executed VBN O
. . O

A DT O
subroutine NN O
to TO O
decompress VB O
the DT O
dropped VBN O
file NN O
is VBZ O
present JJ O
as IN O
'dead NN O
code NN O
' POS O
( NN O
code NN O
that WDT O
is VBZ O
not RB O
used VBN O
) NN O
in IN O
the DT O
binary JJ O
. . O

This DT O
subroutine NN O
will MD O
be VB O
invoked VBN O
on IN O
the DT O
already RB O
closed VBN O
file NN O
handle VB O
of IN O
the DT O
dropped VBN O
file NN O
in IN O
the DT O
present JJ O
code NN O
version NN O
. . O

Since IN O
the DT O
dropped VBN O
resource NN O
is VBZ O
not RB O
compressed VBN O
, , O
the DT O
routine NN O
fails VBZ O
. . O

This DT O
indicates VBZ O
a DT O
low JJ O
sophistication NN O
modification NN O
to TO O
the DT O
original JJ O
dropper NN O
code NN O
to TO O
make VB O
it PRP O
work VB O
with IN O
an DT O
uncompressed JJ O
source NN O
. . O

The DT O
final JJ O
step NN O
the DT B-Entity
dropper NN I-Entity
performs VBZ O
is VBZ O
to TO O
load VB B-Action
the DT B-Entity
dropped VBN I-Entity
DLL NNP I-Entity
into IN B-Modifier
its PRP$ B-Entity
own JJ I-Entity
process NN I-Entity
space NN I-Entity
; : O
it PRP O
then RB O
resolves VBZ O
the DT O
export NN O
'OpenINFOPerformanceData NN O
' '' O
from IN O
the DT O
DLL NNP O
and CC O
invokes VBZ O
it PRP O
with IN O
the DT O
dropped VBN O
DLL NNP O
's POS O
filename NN O
as IN O
parameter NN O
. . O

This DT B-Entity
export NN I-Entity
then RB O
implements VBZ B-Action
the DT B-Entity
actual JJ I-Entity
install VBP I-Entity
logic NN I-Entity
to TO B-Modifier
maintain VB B-Entity
persistence NN I-Entity
and CC O
invoke VB O
the DT O
main JJ O
routine NN O
. . O

The DT O
dropper NN O
binary JJ O
contains VBZ O
an DT O
icon NN O
resource NN O
that WDT O
resembles VBZ O
the DT O
'Google NNP O
Chrome NNP O
' POS O
browser NN O
icon NN O
, , O
the DT O
re- NN O
source NN O
language NN O
is VBZ O
set VBN O
to TO O
'' '' O
Chinese NNP O
( NNP O
Simplified NNP O
) NNP O
'' '' O
, , O
which WDT O
is VBZ O
consistent JJ O
with IN O
the DT O
builder NN O
of IN O
the DT O
tool NN O
systems NNS O
language NN O
set VBN O
to TO O
Chinese NNP O
. . O

The DT B-Entity
use NN I-Entity
of IN I-Entity
the DT I-Entity
Chrome NNP I-Entity
icon NN I-Entity
may MD O
indicate VB O
a DT O
possible JJ O
attempt NN O
to TO O
socially RB B-Action
engineer VB I-Action
the DT B-Entity
intended JJ I-Entity
victim NN I-Entity
into IN B-Modifier
thinking VBG B-Entity
the DT I-Entity
dropper NN I-Entity
was VBD I-Entity
a DT I-Entity
legitimate JJ I-Entity
file NN I-Entity
associated VBN I-Entity
with IN I-Entity
Google NNP I-Entity
. . O

This DT B-Entity
sample NN I-Entity
is VBZ B-Action
a DT B-Entity
'backdoor NN I-Entity
' '' I-Entity
which WDT O
is VBZ O
the DT B-Entity
DLL NNP I-Entity
dropped VBD B-Action
by IN O
the DT B-Entity
dropper NN I-Entity
sample NN I-Entity
file NN I-Entity
with IN O
an DT O
MD5 NN O
of IN O
14c04f88dc97aef3e9b516ef208a2bf5 NN O
. . O

This DT O
code NN O
appears VBZ O
to TO O
have VB O
been VBN O
compiled VBN O
on IN O
Wednesday NNP O
May NNP O
4th JJ O
, , O
2011 CD O
at IN O
10:48:19 CD O
A.M. NNP O
UTC NNP O
( NN O
equivalent JJ O
to TO O
early JJ O
evening NN O
time NN O
in IN O
China NNP O
) NNP O
. . O

It PRP O
is VBZ O
instantiated VBN O
when WRB O
it PRP B-Entity
is VBZ B-Action
mapped VBN I-Action
into IN B-Modifier
the DT B-Entity
process NN I-Entity
space NN I-Entity
of IN I-Entity
its PRP$ I-Entity
dropped VBN I-Entity
file NN I-Entity
, , O
and CC O
its PRP$ O
' POS O
export NN O
named VBD O
'OpenINFOPerformanceData NN O
' '' O
is VBZ O
called VBN O
. . O

This DT O
export NN O
first RB O
attempts VBZ O
to TO O
stop VB O
a DT O
service NN O
called VBN O
'' '' O
msupdate NN O
'' '' O
, , O
which WDT O
is VBZ O
not RB O
a DT O
known JJ O
Microsoft NNP O
Windows NNP O
service NN O
despite IN O
the DT O
appearance NN O
. . O

If IN O
the DT O
service NN O
is VBZ O
present JJ O
, , O
the DT B-Entity
malware NN I-Entity
replaces VBZ B-Action
its PRP$ B-Entity
previous JJ I-Entity
instances NNS I-Entity
or CC I-Entity
versions NNS I-Entity
of IN I-Entity
this DT I-Entity
backdoor NN I-Entity
. . O

After IN O
attempting VBG O
to TO O
disable VB O
the DT O
existing VBG O
service NN O
, , O
the DT B-Entity
malware NN I-Entity
tries VBZ O
to TO O
install VB B-Action
itself PRP B-Entity
as IN B-Modifier
a DT B-Entity
service NN I-Entity
with IN I-Entity
that DT I-Entity
same JJ I-Entity
name NN I-Entity
. . O

During IN O
installation NN O
, , O
the DT B-Entity
sample NN I-Entity
attempts VBZ O
to TO O
use VB B-Action
documented JJ B-Entity
APIs NNS I-Entity
such JJ I-Entity
as IN I-Entity
OpenSCManager NNP I-Entity
( NNP I-Entity
) NNP I-Entity
and CC I-Entity
CreateService NNP I-Entity
( NNP I-Entity
) NNP I-Entity
to TO B-Modifier
initialize VB B-Entity
itself PRP I-Entity
as IN I-Entity
a DT I-Entity
persistent JJ I-Entity
Windows NNP I-Entity
service NN I-Entity
. . O

As IN O
a DT O
precaution NN O
, , O
the DT B-Entity
sample NN I-Entity
writes VBZ B-Action
settings NNS B-Entity
directly RB B-Modifier
to TO I-Modifier
the DT B-Entity
Windows NNP I-Entity
Registry NNP I-Entity
to TO O
accomplish VB O
the DT O
same JJ O
goal NN O
if IN O
installing VBG O
the DT O
service NN O
with IN O
the DT O
documented VBN O
APIs NNS O
fails VBZ O
. . O

The DT B-Entity
registry NN I-Entity
change NN I-Entity
creates VBZ B-Action
the DT B-Entity
following JJ I-Entity
key NN I-Entity
: : O
Following VBG O
this DT O
, , O
the DT B-Entity
subroutine NN I-Entity
will MD O
set VB B-Action
the DT B-Entity
value NN I-Entity
of IN I-Entity
the DT I-Entity
'ServiceDLL NN I-Entity
' '' I-Entity
to TO B-Modifier
the DT B-Entity
module NN I-Entity
handle VB I-Entity
of IN I-Entity
the DT I-Entity
DLL NNP I-Entity
. . O

The DT B-Entity
next JJ I-Entity
key NN I-Entity
to TO O
be VB B-Action
changed VBN I-Action
is VBZ O
: : O
HKEYLOCALMACHINE\\SOFTWARE\\Microsoft\\Windows FW O
NT\\CurrentVersion\\Svchost FW O
, , O
which WDT O
will MD O
have VB O
the DT B-Entity
'msupdate NN I-Entity
' POS I-Entity
key JJ I-Entity
set NN B-Action
to TO B-Modifier
'msupdate NN B-Entity
' '' I-Entity
. . O

The DT B-Entity
export NN I-Entity
'CollectW3PerfData NN I-Entity
' '' I-Entity
is VBZ B-Action
registered VBN I-Action
as IN B-Modifier
the DT B-Entity
main JJ I-Entity
function NN I-Entity
of IN I-Entity
the DT I-Entity
DLL NNP I-Entity
. . O

If IN O
the DT O
installation NN O
of IN O
the DT O
new JJ O
service NN O
is VBZ O
successful JJ O
, , O
the DT B-Entity
sample NN I-Entity
then RB O
starts VBZ B-Action
the DT B-Entity
new JJ I-Entity
service NN I-Entity
and CC O
exits NNS O
. . O

If IN O
the DT O
installation NN O
fails VBZ O
, , O
the DT B-Entity
sample NN I-Entity
spawns VBZ B-Action
a DT B-Entity
new JJ I-Entity
process NN I-Entity
using VBG B-Modifier
rundll32.exe NN B-Entity
, , O
this DT O
executable JJ O
will MD O
instantiate VB O
the DT O
DLL NNP O
and CC O
can MD O
call VB O
a DT O
specific JJ O
exported VBN O
function NN O
. . O

In IN O
the DT O
case NN O
of IN O
installation NN O
failure NN O
, , O
rundll32.exe NN O
calls VBZ O
the DT O
main JJ O
functions NNS O
export NN O
'CollectW3PerfData NN O
' '' O
. . O

The DT O
rundll32.exe NN O
is VBZ O
instantiated VBN O
with IN O
a DT O
new JJ O
NULL NNP O
Security NNP O
Identifier NNP O
( FW O
SID FW O
) FW O
( FW O
S-1-0-0 FW O
) FW O
with IN O
permissions NNS B-Entity
set VBN B-Action
to TO B-Modifier
grant VB B-Entity
all DT I-Entity
access NN I-Entity
to TO I-Entity
the DT I-Entity
file NN I-Entity
. . O

This DT B-Entity
allows VBZ B-Action
any DT B-Entity
user NN I-Entity
to TO B-Modifier
have VB B-Entity
complete JJ I-Entity
control NN I-Entity
over IN I-Entity
the DT I-Entity
machine NN I-Entity
, , O
as IN O
rundll32.exe NN O
is VBZ O
frequently RB O
launched VBN O
by IN O
tasks NNS O
such JJ O
as IN O
changing VBG O
the DT O
time NN O
, , O
wallpaper NN O
, , O
or CC O
other JJ O
system NN O
settings NNS O
. . O

This DT O
means VBZ O
that IN O
after IN O
cleaning VBG B-Action
up RP I-Action
the DT B-Entity
components NNS I-Entity
dropped VBN I-Entity
by IN I-Entity
the DT I-Entity
malware NN I-Entity
, , O
the DT B-Entity
system NN I-Entity
remains VBZ B-Action
vulnerable JJ B-Entity
to TO I-Entity
local JJ I-Entity
attacks NNS I-Entity
by IN O
simply RB O
overwriting VBG O
the DT O
legitimate JJ O
rundll32.exe NN O
executable JJ O
with IN O
a DT O
malicious JJ O
version NN O
and CC O
await VB O
it PRP O
's POS O
automatic JJ O
execution NN O
by IN O
the DT O
Operating NNP O
System NNP O
. . O

The DT O
main JJ O
entry NN O
point NN O
to TO O
the DT O
DLL NNP O
is VBZ O
named VBN O
'CollectW3PerfData NN O
' '' O
, , O
as IN O
it PRP O
first RB O
creates VBZ O
and CC O
displays VBZ O
a DT O
fake JJ O
Window NN O
with IN O
class NN O
'' '' O
NOD32 CD O
% NN O
d NN O
'' '' O
where WRB O
% NN O
d NN O
is VBZ O
replaced VBN O
with IN O
a DT O
pseudo-random JJ O
number NN O
. . O

This DT O
may MD O
be VB O
an DT O
attempt NN O
to TO O
fool VB B-Action
some DT B-Entity
automated JJ I-Entity
dynamic JJ I-Entity
analysis NN I-Entity
or CC I-Entity
anti-malware JJ I-Entity
software NN I-Entity
into IN B-Modifier
believing VBG B-Entity
this DT I-Entity
is VBZ I-Entity
the DT I-Entity
legitimate JJ I-Entity
ESET NN I-Entity
AV NN I-Entity
software NN I-Entity
. . O

The DT O
window NN O
is VBZ O
however RB O
not RB O
visible JJ O
and CC O
implements VBZ O
no DT O
specific JJ O
functionality NN O
. . O

After IN O
creating VBG O
this DT O
window NN O
, , O
the DT B-Entity
routine NN I-Entity
starts VBZ O
the DT O
main JJ O
thread NN O
that WDT O
eventually RB O
initiates VBZ B-Action
calling VBG B-Entity
out RP I-Entity
to TO I-Entity
the DT I-Entity
Command NN I-Entity
and CC I-Entity
Control NN I-Entity
( NN I-Entity
C2 NN I-Entity
) NN I-Entity
. . O

In IN O
order NN O
to TO O
accomplish VB O
this DT O
task NN O
, , O
the DT O
newly RB O
created VBN O
thread NN O
initializes NNS O
networking VBG O
APIs NNS O
using VBG O
WSAStartup NN O
( FW O
) FW O
and CC O
resolves VBZ O
some DT O
other JJ O
APIs NNS O
dynamically RB O
using VBG O
LoadLibrary NNP O
( NNP O
) NNP O
and CC O
GetProcAddress NNP O
( NNP O
) NNP O
. . O

Once RB O
the DT O
proper JJ O
API NNP O
's POS O
have VBP O
been VBN O
resolved VBN O
, , O
the DT O
sample NN O
then RB O
assigns VBZ O
a DT O
NULL NNP O
SID NNP O
to TO O
the DT O
rundll32.exe NN O
executable JJ O
and CC O
sets VBZ O
the DT O
current JJ O
process NN O
' '' O
Window NNP O
Station NNP O
to TO O
'' '' O
winsta0 NN O
'' '' O
, , O
which WDT O
enables VBZ O
the DT B-Entity
sample NN I-Entity
to TO O
access VB B-Action
the DT B-Entity
real JJ I-Entity
user NN I-Entity
's POS I-Entity
desktop NN I-Entity
if IN B-Modifier
started VBN B-Entity
as IN I-Entity
service NN I-Entity
. . O

The DT B-Entity
communication NN I-Entity
to TO I-Entity
the DT I-Entity
C2 NN I-Entity
is VBZ B-Action
handled VBN I-Action
by IN B-Modifier
a DT B-Entity
while NN I-Entity
( FW I-Entity
) FW I-Entity
loop NN I-Entity
, , O
with IN O
each DT O
successive JJ O
connection NN O
attempt NN O
causing VBG O
the DT O
loop NN O
to TO O
invoke VB O
the DT O
Windows NNP O
Sleep NNP O
( NNP O
) NNP O
API NNP O
for IN O
a DT O
time NN O
interval NN O
of IN O
2 CD O
seconds NNS O
, , O
exponentially RB O
increasing VBG O
in IN O
length NN O
up IN O
to TO O
1024 CD O
seconds NNS O
( CD O
17 CD O
minutes NNS O
) NN O
and CC O
then RB O
restarting VBG O
back RB O
to TO O
2 CD O
seconds NNS O
. . O

The DT O
C2 NN O
location NN O
in IN O
this DT O
sample NN O
is VBZ O
statically RB O
defined VBN O
as IN O
1.9.5.38:443 NNP O
( NNP O
Malaysia NNP O
: : O
Tmnet NNP O
, , O
Telekom NNP O
Malaysia NNP O
Bhd NNP O
) NNP O
. . O

While IN O
ther NN O
is VBZ O
'dead JJ O
code NN O
' '' O
that WDT O
will MD O
download VB O
the DT O
C2 NN O
location NN O
from IN O
an DT O
HTTP NN O
URL NN O
that WDT O
could MD O
be VB O
defined VBN O
in IN O
the DT O
binary JJ O
, , O
using VBG O
the DT O
User-Agent JJ O
string NN O
'' '' O
Google NNP O
'' '' O
, , O
this DT O
code NN O
is VBZ O
not RB O
activated VBN O
due JJ O
to TO O
the DT O
format NN O
of IN O
the DT O
stat- NN O
ically RB O
defined VBN O
C2 NN O
location NN O
using VBG O
an DT O
IP NNP O
address NN O
. . O

Thus RB O
the DT B-Entity
sample NN I-Entity
will MD O
only RB O
attempt VB O
to TO O
connect VB B-Action
directly RB O
using VBG B-Modifier
a DT B-Entity
raw JJ I-Entity
socket NN I-Entity
to TO B-Modifier
the DT B-Entity
C2 NN I-Entity
located JJ I-Entity
at IN I-Entity
1.9.5.38:443 CD I-Entity
. . O

This DT O
indicates VBZ O
the DT O
use NN O
of IN O
a DT O
'boiler NN O
plate NN O
code NN O
' '' O
or CC O
a DT O
builder NN O
software NN O
package NN O
that WDT O
automates VBZ O
the DT O
creation NN O
of IN O
the DT O
malicious JJ O
sample NN O
. . O

The DT B-Entity
malicious JJ I-Entity
sample NN I-Entity
sends VBZ B-Action
an DT B-Entity
initial JJ I-Entity
beacon NN I-Entity
to TO B-Modifier
the DT B-Entity
C2 NN I-Entity
that WDT O
includes VBZ O
the DT O
following JJ O
information NN O
: : O
The DT B-Entity
beacon NN I-Entity
is VBZ B-Action
encrypted VBN I-Action
using VBG B-Modifier
an DT B-Entity
XOR/ADD NN I-Entity
loop NN I-Entity
using VBG I-Entity
the DT I-Entity
statically RB I-Entity
defined VBN I-Entity
key JJ I-Entity
0x1C NN I-Entity
and CC O
sent VBN B-Action
to TO B-Modifier
the DT B-Entity
C2 NN I-Entity
. . O

The DT O
following VBG O
python NN O
function NN O
can MD O
be VB O
used VBN O
to TO O
decode VB O
the DT O
beacon NN O
stings VBZ O
: : O
After IN O
sending VBG B-Action
the DT B-Entity
initial JJ I-Entity
beacon NN I-Entity
, , O
the DT B-Entity
routine JJ I-Entity
loops NNS O
receiving VBG B-Action
incoming JJ B-Entity
commands NNS I-Entity
and CC O
executes VBZ B-Action
them PRP B-Entity
in IN O
sequence NN O
. . O

When WRB O
a DT O
connection NN O
can MD O
successfully RB O
be VB O
established VBN O
to TO O
the DT O
C2 NN O
server NN O
, , O
the DT O
sleep NN O
timer NN O
is VBZ O
reset JJ O
to TO O
two CD O
seconds NNS O
for IN O
the DT O
next JJ O
attempt NN O
. . O

The DT O
network NN O
protocol NN O
used VBN O
by IN O
this DT O
sample NN O
resembles VBZ O
a DT O
'Type-Length-Value NN O
' POS O
layout NN O
in IN O
both DT O
directions NNS O
. . O

Each DT O
16 CD O
byte NN O
request NN O
header NN O
consists VBZ O
of IN O
: : O
Zero NNP O
or CC O
more JJR O
of IN O
specified JJ O
bytes NNS O
of IN O
additional JJ O
payload NN O
then RB O
follows VBZ O
the DT O
header NN O
. . O

This DT B-Entity
inbound JJ I-Entity
payload NN I-Entity
is VBZ B-Action
received VBN I-Action
unconditionally RB O
and CC O
regardless RB O
of IN O
command NN O
type NN O
into IN O
a DT O
fixed-size NN O
stack VB O
buffer NN O
of IN O
408 CD O
bytes NNS O
size NN O
. . O

Providing VBG O
additional JJ O
payload NN O
of IN O
any DT O
larger JJR O
size NN O
will MD O
result VB O
in IN O
a DT O
trivial JJ O
exploitable JJ O
stack VBP O
buffer NN O
overflow NN O
that WDT O
allows VBZ O
arbitrary JJ O
code NN O
execution NN O
due JJ O
to TO O
the DT O
absence NN O
of IN O
any DT O
security NN O
features NNS O
. . O

However RB O
, , O
exploitation NN O
of IN O
this DT O
vulnerability NN O
is VBZ O
unnecessary JJ O
due JJ O
to TO O
the DT O
already RB O
available JJ O
unauthenticated JJ O
command NN O
execution NN O
capabilities NNS O
of IN O
this DT O
backdoor NN O
. . O

Certain JJ O
commands NNS O
initiate VBP O
a DT O
second JJ O
connection NN O
to TO O
the DT O
C2 NN O
in IN O
a DT O
separate JJ O
thread NN O
using VBG O
the DT O
same JJ O
network NN O
protocol NN O
but CC O
providing VBG O
a DT O
different JJ O
request NN O
command NN O
identifier NN O
than IN O
for IN O
the DT O
initial JJ O
beacon NN O
. . O

The DT B-Entity
primary JJ I-Entity
aim NN I-Entity
of IN I-Entity
this DT I-Entity
backdoor NN I-Entity
is VBZ B-Action
remote JJ B-Entity
desktop NN I-Entity
control NN I-Entity
functionality NN I-Entity
comparable JJ I-Entity
to TO I-Entity
VNC NNP I-Entity
or CC I-Entity
Remote NNP I-Entity
Desktop NNP I-Entity
over IN I-Entity
a DT I-Entity
custom NN I-Entity
protocol NN I-Entity
. . O

It PRP O
allows VBZ O
the DT B-Entity
adversary NN I-Entity
to TO O
view VB B-Action
the DT B-Entity
main JJ I-Entity
desktop NN I-Entity
graphically RB B-Entity
and CC O
control VBP B-Action
the DT B-Entity
keyboard NN I-Entity
and CC O
mouse NN B-Entity
. . O

This DT B-Entity
remote JJ I-Entity
control NN I-Entity
functionality NN I-Entity
is VBZ B-Action
implemented VBN I-Action
as IN B-Modifier
separate JJ B-Entity
messages NNS I-Entity
for IN I-Entity
mouse NN I-Entity
clicks NNS I-Entity
, , I-Entity
pressed VBN I-Entity
keys NNS I-Entity
, , I-Entity
etc FW I-Entity
. . I-Entity

using VBG B-Modifier
command NN B-Entity
identifiers NNS I-Entity
0x20000002 CD I-Entity
to TO I-Entity
0x20000019 CD I-Entity
. . O

The DT B-Entity
command NN I-Entity
0x22000001 NN I-Entity
initiates VBZ B-Action
continuous JJ B-Entity
transmission NN I-Entity
of IN I-Entity
screen NN I-Entity
captures VBZ I-Entity
to TO I-Entity
the DT I-Entity
C2 NN I-Entity
. . O

The DT B-Entity
screen NN I-Entity
captures VBZ I-Entity
are VBP B-Action
created VBN I-Action
using VBG B-Modifier
a DT B-Entity
series NN I-Entity
of IN I-Entity
Microsoft NNP I-Entity
Windows NNP I-Entity
Graphic NNP I-Entity
Device NNP I-Entity
Interface NNP I-Entity
( NNP I-Entity
GDI NNP I-Entity
) NNP I-Entity
API NNP I-Entity
calls VBZ I-Entity
culminating VBG I-Entity
in IN I-Entity
a DT I-Entity
call NN I-Entity
to TO I-Entity
GetDIBits NNP I-Entity
( NNP I-Entity
) NNP I-Entity
. . O

Command NN O
0x20000001 NN O
exits NNS O
the DT O
backdoor NN O
and CC O
0x20000000 NN B-Entity
is VBZ O
issued VBN O
to TO O
completely RB O
remove VB B-Action
the DT B-Entity
backdoor NN I-Entity
from IN B-Modifier
the DT B-Entity
system NN I-Entity
. . O

When WRB O
command NN O
0x23000004 NN O
is VBZ O
received VBN O
, , O
a DT B-Entity
temporary JJ I-Entity
new JJ I-Entity
user NN I-Entity
'' '' I-Entity
DomainUser NN I-Entity
'' '' I-Entity
with IN I-Entity
password NN I-Entity
'' '' I-Entity
Dom4 NN I-Entity
! . I-Entity
nU- FW I-Entity
serP4ss FW I-Entity
'' '' I-Entity
is VBZ B-Action
created VBN I-Action
and CC O
added VBN B-Action
to TO B-Modifier
the DT B-Entity
local JJ I-Entity
Administrators NNPS I-Entity
group NN I-Entity
. . O

The DT B-Entity
backdoor NN I-Entity
is VBZ B-Action
then RB I-Action
started VBN I-Action
under IN B-Modifier
that DT B-Entity
account NN I-Entity
and CC O
the DT B-Entity
user NN I-Entity
is VBZ B-Action
deleted VBN I-Action
. . O

It PRP O
would MD O
appear VB O
this DT B-Entity
technique NN I-Entity
is VBZ O
meant VBN O
to TO O
obfuscate VB B-Action
the DT B-Entity
activities NNS I-Entity
of IN I-Entity
the DT I-Entity
malicious JJ I-Entity
sample NN I-Entity
by IN B-Modifier
masking VBG B-Entity
the DT I-Entity
process NN I-Entity
creator NN I-Entity
's POS I-Entity
user NN I-Entity
name NN I-Entity
to TO I-Entity
appear VB I-Entity
to TO I-Entity
be VB I-Entity
a DT I-Entity
generic JJ I-Entity
domain NN I-Entity
user NN I-Entity
. . O

Note VB O
that IN O
such PDT O
an DT O
account NN O
does VBZ O
not RB O
normally RB O
exist VB O
in IN O
an DT O
Active JJ O
Directory NNP O
environment NN O
. . O

Additionally RB O
, , O
the DT O
primary JJ O
C2 NN O
connection NN O
allows VBZ O
for IN O
requests NNS O
to TO O
start VB O
additional JJ O
connections NNS O
to TO O
the DT O
C2 NN O
imple- NN O
menting VBG O
the DT O
following JJ O
functionality NN O
: : O
This DT O
sample NN O
is VBZ O
typical JJ O
of IN O
a DT O
post NN O
exploitation NN O
tool NN O
; : O
it PRP O
is VBZ O
written VBN O
in IN O
.NET NN O

2.0 CD O
. . O

This DT O
code NN O
appears VBZ O
to TO O
have VB O
been VBN O
compiled VBN O
on IN O
Thursday NNP O
May NNP O
26th JJ O
, , O
2011 CD O
at IN O
10:21:44 CD O
A.M. NNP O
UTC NNP O
( NNP O
early JJ O
evening NN O
time NN O
in IN O
China NNP O
) NNP O
. . O

The DT O
backdoor JJ O
functionality NN O
can MD O
be VB O
instantiated VBN O
either CC O
directly RB O
from IN O
the DT O
command NN O
line NN O
or CC O
through IN O
commands NNS B-Entity
issued VBN B-Action
over IN B-Modifier
a DT B-Entity
network NN I-Entity
based JJ I-Entity
protocol NN I-Entity
via IN B-Modifier
the DT B-Entity
C2 NN I-Entity
. . O

If IN O
no DT O
arguments NNS O
are VBP O
given VBN O
, , O
a DT B-Entity
connection NN I-Entity
to TO I-Entity
the DT I-Entity
C2 NN I-Entity
is VBZ B-Action
initiated VBN I-Action
to TO B-Modifier
the DT B-Entity
stati- NN I-Entity
cally RB I-Entity
defined VBN I-Entity
IP NNP I-Entity
address NN I-Entity
. . O

The DT B-Entity
command NN I-Entity
line NN I-Entity
options NNS I-Entity
support VBP B-Action
post NN O
exploitation NN O
capabilities NNS O
such JJ O
as IN O
changing VBG B-Entity
file NN I-Entity
timestamps NNS I-Entity
, , O
forensic JJ B-Entity
mitigation NN I-Entity
, , O
privilege NN B-Entity
escalation NN I-Entity
, , O
launching VBG B-Entity
the DT I-Entity
executable JJ I-Entity
, , O
and CC O
specifying VBG B-Entity
a DT I-Entity
specific JJ I-Entity
C2 NN I-Entity
. . O

One CD O
interesting JJ O
command NN O
line NN O
option NN O
allows VBZ O
the DT B-Entity
backdoor NN I-Entity
to TO O
filter NN B-Action
the DT B-Entity
contents NNS I-Entity
of IN I-Entity
specified JJ I-Entity
files NNS I-Entity
to TO O
remove VB B-Action
content NN B-Entity
using VBG B-Modifier
a DT B-Entity
regular JJ I-Entity
expression NN I-Entity
( NN I-Entity
regex NN I-Entity
) NN I-Entity
. . O

This DT B-Entity
command NN I-Entity
then RB O
modifies VBZ B-Action
the DT B-Entity
creation NN I-Entity
, , I-Entity
modification NN I-Entity
, , I-Entity
and CC I-Entity
last JJ I-Entity
access NN I-Entity
timestamps NNS I-Entity
of IN I-Entity
the DT I-Entity
modified VBN I-Entity
file NN I-Entity
to TO B-Modifier
conceal VB B-Entity
the DT I-Entity
content NN I-Entity
modifications NNS I-Entity
. . O

A DT O
detailed JJ O
listing NN O
of IN O
command NN O
line NN O
arguments NNS O
can MD O
be VB O
viewed VBN O
in IN O
Appendix NN O
A NN O
. . O

This DT B-Entity
activity NN I-Entity
is VBZ B-Action
generally RB I-Action
associated VBN I-Action
with IN B-Modifier
log NN B-Entity
cleaning NN I-Entity
to TO I-Entity
com- FW I-Entity
plicate FW I-Entity
a DT I-Entity
forensic JJ I-Entity
investigation NN I-Entity
. . O

The DT O
sample NN O
contains VBZ O
an DT O
embedded JJ O
IP NNP O
address NN O
for IN O
C2 NN O
that WDT O
is VBZ O
stored VBN O
in IN O
an DT O
encrypted JJ O
format NN O
as IN O
a DT O
string NN O
re- NN O
source NN O
: : O
The DT O
first JJ O
two CD O
bytes NNS O
of IN O
this DT O
string NN O
represent VBP O
the DT O
base NN O
16 CD O
length NN O
of IN O
the DT O
encrypted JJ O
string NN O
, , O
in IN O
this DT O
case NN O
, , O
'' '' O
0x14 NN O
'' '' O
. . O

Following VBG O
this DT O
is VBZ O
a DT O
base64 NN O
encoded VBN O
string NN O
of IN O
the DT O
specified VBN O
length NN O
. . O

Once RB O
this DT O
string NN O
has VBZ O
been VBN O
decoded VBN O
using VBG O
base64 NN O
, , O
the DT O
result NN O
is VBZ O
then RB O
XOR NNP O
'd NNP O
with IN O
the DT O
fixed JJ O
value NN O
of IN O
0xAA NN O
yielding VBG O
the DT O
decoded VBN O
IP NNP O
address NN O
202.86.190.3:80 NNP O
( NNP O
Hong NNP O
Kong NNP O
: : O
TeleOne NNP O
( NNP O
HK NNP O
) NNP O
Limited NNP O
) NNP O
. . O

There EX O
are VBP O
three CD O
components NNS O
to TO O
the DT O
protocol NN O
: : O
Authentication NN B-Entity
is VBZ B-Action
accomplished VBN I-Action
using VBG B-Modifier
a DT B-Entity
32 CD I-Entity
byte NN I-Entity
packet NN I-Entity
, , O
this DT O
packet NN O
consists VBZ O
of IN O
: : O
An DT B-Entity
example NN I-Entity
authentication NN I-Entity
packet NN I-Entity
sent VBN B-Action
to TO B-Modifier
the DT B-Entity
C2 NN I-Entity
is VBZ O
located JJ O
in IN O
Appendix NNP O
E. NNP O
After IN O
sending VBG B-Action
the DT B-Entity
initial JJ I-Entity
authentication NN I-Entity
packet NN I-Entity
, , O
the DT B-Entity
sample NN I-Entity
verifies VBZ B-Action
that IN B-Modifier
the DT B-Entity
first JJ I-Entity
four CD I-Entity
bytes NNS I-Entity
of IN I-Entity
the DT I-Entity
response NN I-Entity
is VBZ I-Entity
equal JJ I-Entity
to TO I-Entity
a DT I-Entity
statically RB I-Entity
defined VBN I-Entity
value NN I-Entity
, , O
in IN O
this DT O
sample NN O
the DT O
value NN O
is VBZ O
: : O
0x16030100 NN O
. . O

In IN O
addition NN O
, , O
an DT B-Entity
8 CD I-Entity
byte NN I-Entity
key NN I-Entity
is VBZ B-Action
sent VBN I-Action
to TO B-Modifier
the DT B-Entity
client NN I-Entity
which WDT O
is VBZ O
then RB O
RC4 NN O
encrypted VBD O
using VBG O
the DT O
random JJ O
number NN O
generated VBN O
in IN O
step NN O
2 CD O
from IN O
above RB O
as IN O
the DT O
password NN O
. . O

This DT O
value NN O
is VBZ O
then RB O
transformed VBN O
using VBG O
a DT O
simple JJ O
algorithm NN O
in IN O
Appendix NN O
F NN O
into IN O
a DT O
32 CD O
byte NN O
array NN O
. . O

The DT O
first JJ O
16 CD O
bytes NNS O
of IN O
this DT O
array NN O
are VBP O
then RB O
used VBN O
as IN O
the DT O
KEY NNP O
and CC O
the DT O
second JJ O
16 CD O
bytes NNS O
are VBP O
used VBN O
as IN O
the DT O
IV NNP O
for IN O
setting VBG O
up RP O
AES NN B-Entity
encryption NN I-Entity
which WDT O
is VBZ O
then RB O
used VBN O
to TO O
encrypt VB B-Action
and CC I-Action
decrypt VB I-Action
any DT B-Entity
further JJ I-Entity
communications NNS I-Entity
. . O

Beacon NNP O
, , O
this DT O
is VBZ O
typical JJ O
of IN O
this DT O
type NN O
of IN O
malicious JJ O
sample NN O
, , O
it PRP O
allows VBZ O
the DT O
operator NN O
to TO O
separate VB O
various JJ O
infected JJ O
hosts NNS O
in IN O
a DT O
targeted VBN O
campaign NN O
. . O

The DT O
beacon NN O
for IN O
this DT O
sample NN O
is VBZ O
formatted VBN O
as IN O
XML NN O
and CC O
consists VBZ O
of IN O
: : O
An DT O
example NN O
of IN O
an DT O
unencrypted JJ O
beacon NN O
: : O
Command NN B-Entity
handling NN I-Entity
loop NN I-Entity
, , O
this DT O
is VBZ O
a DT O
loop NN O
structure NN O
that WDT O
will MD O
process VB B-Action
and CC I-Action
execute VB I-Action
commands NNS B-Entity
sent VBN I-Entity
by IN I-Entity
the DT I-Entity
C2 NN I-Entity
. . O

The DT B-Entity
malware NN I-Entity
sends VBZ B-Action
and CC O
receives VBZ B-Action
a DT B-Entity
heartbeat/keepalive JJ I-Entity
packet NN I-Entity
every DT B-Modifier
2 CD B-Entity
minutes NNS I-Entity
. . O

The DT O
command NN O
format NN O
is VBZ O
derived VBN O
from IN O
a DT O
structure NN O
consisting VBG O
of IN O
: : O
These DT O
fields NNS O
are VBP O
received VBN O
as IN O
a DT O
sequence NN O
of IN O
serialized FW O
.NET FW O

objects NNS O
in IN O
the DT O
order NN O
specified VBN O
. . O

A DT O
detailed JJ O
description NN O
of IN O
the DT O
possible JJ O
values NNS O
for IN O
commands NNS O
is VBZ O
in IN O
Appendix NNP O
D. NNP O
It PRP O
is VBZ O
important JJ O
to TO O
note VB O
that IN O
the DT O
order NN O
in IN O
which WDT O
the DT O
application NN O
defines VBZ O
them PRP O
is VBZ O
not RB O
the DT O
same JJ O
order NN O
as IN O
they PRP O
appear VBP O
to TO O
be VB O
coming VBG O
over IN O
the DT O
network NN O
. . O

Examples NNS O
of IN O
implemented VBN O
commands NNS O
include VBP O
download NN B-Action
and CC O
upload NN B-Action
files NNS B-Entity
, , O
installing VBG B-Action
new JJ B-Entity
.NET NNP I-Entity
assemblies NNS I-Entity
, , O
calling VBG B-Action
methods NNS B-Entity
on IN B-Modifier
those DT B-Entity
assemblies NNS I-Entity
, , O
connecting VBG B-Action
to TO B-Modifier
new JJ B-Entity
C2 NN I-Entity
servers NNS I-Entity
and CC O
executing VBG B-Action
processes NNS B-Entity
. . O

This DT B-Entity
sample NN I-Entity
is VBZ B-Action
a DT B-Entity
sophisticated JJ I-Entity
backdoor NN I-Entity
which WDT O
implements VBZ B-Action
several JJ B-Entity
communications NNS I-Entity
protocols NNS I-Entity
and CC O
was VBD O
developed VBN O
in IN O
C++ NNP O
. . O

This DT O
binary JJ O
is VBZ O
compiled VBN O
with IN O
the DT O
/GS NN O
flag NN O
using VBG O
Visual JJ O
Studio NN O
2010 CD O
, , O
enabling VBG O
stack VBP O
buffer NN O
overflow NN O
detection NN O
. . O

This DT O
code NN O
appears VBZ O
to TO O
have VB O
been VBN O
compiled VBN O
on IN O
Sunday NNP O
October NNP O
30 CD O
, , O
2011 CD O
at IN O
12:43:33 CD O
P.M. NNP O
UTC NNP O
( NNP O
late JJ O
evening NN O
time NN O
in IN O
China NNP O
) NNP O
. . O

The DT O
code NN O
contains VBZ O
several JJ O
Run NNP O
Time NNP O
Type NN O
Information NNP O
( NNP O
RTTI NNP O
) NN O
artifacts NNS O
that WDT O
indicate VBP O
most JJS O
of IN O
the DT O
C++ NNP O
class NN O
names NNS O
were VBD O
prefixed VBN O
with IN O
the DT O
string NN O
'' '' O
PCC NN O
'' '' O
in IN O
the DT O
original JJ O
source NN O
code NN O
. . O

Variants NNS O
of IN O
this DT O
Trojan NNP O
are VBP O
sometimes RB O
detected VBN O
under IN O
the DT O
name NN O
'Derusbi NN O
' '' O
by IN O
Microsoft NNP O
, , O
Trend NNP O
, , O
Sophos NNP O
and CC O
Symantec NNP O
AV NNP O
engines NNS O
. . O

This DT B-Entity
sample NN I-Entity
is VBZ O
a DT B-Entity
DLL NN I-Entity
which WDT O
can MD O
be VB B-Action
registered VBN I-Action
as IN B-Modifier
a DT B-Entity
service NN I-Entity
and CC O
is VBZ O
used VBN O
to TO O
drop VB B-Action
a DT B-Entity
kernel NN I-Entity
driver NN I-Entity
and CC O
provide VB B-Action
an DT B-Entity
interactive JJ I-Entity
command NN I-Entity
line NN I-Entity
shell NN I-Entity
to TO B-Modifier
the DT B-Entity
C2 NN I-Entity
. . O

It PRP B-Entity
also RB O
is VBZ O
able JJ O
to TO O
bypass VB B-Action
User NN B-Entity
Account NNP I-Entity
Control NNP I-Entity
( NNP I-Entity
UAC NNP I-Entity
) NNP I-Entity
to TO B-Modifier
install VB B-Entity
itself PRP I-Entity
by IN I-Entity
using VBG I-Entity
the DT I-Entity
'sysprep.exe NN I-Entity
' '' I-Entity
Microsoft NNP I-Entity
Windows NNP I-Entity
executable JJ I-Entity
provided VBN I-Entity
by IN I-Entity
the DT I-Entity
targeted VBN I-Entity
system NN I-Entity
. . O

The DT O
steps NNS O
it PRP O
takes VBZ O
to TO O
install VB O
itself PRP O
onto IN O
a DT O
system NN O
are VBP O
as IN O
follows VBZ O
: : O
2 CD O
. . O

After IN O
it PRP B-Entity
copies NNS B-Action
itself PRP B-Entity
, , O
it PRP B-Entity
will MD O
modify VB B-Action
the DT B-Entity
creation NN I-Entity
time NN I-Entity
, , I-Entity
last JJ I-Entity
access NN I-Entity
time NN I-Entity
and CC I-Entity
last JJ I-Entity
modification NN I-Entity
time NN I-Entity
to TO B-Modifier
the DT B-Entity
current JJ I-Entity
system NN I-Entity
time NN I-Entity
when WRB I-Entity
the DT I-Entity
copy NN I-Entity
was VBD I-Entity
made VBN I-Entity
but CC I-Entity
with IN I-Entity
the DT I-Entity
year NN I-Entity
changed VBD I-Entity
to TO I-Entity
2005 CD I-Entity
. . O

3 CD O
. . O

Adds NNP B-Action
itself PRP B-Entity
as IN B-Modifier
a DT B-Entity
service NN I-Entity
name NN I-Entity
from IN B-Modifier
the DT B-Entity
backdoor NN I-Entity
's POS I-Entity
configuration NN I-Entity
under IN B-Modifier
HKEYLOCAL FW B-Entity
MACHINE\\SYSTEM\\CurrentControlSet\\Services\\ FW I-Entity
< JJR I-Entity
service NN I-Entity
> JJR I-Entity
'' '' I-Entity
This DT O
defaults NNS O
to TO O
'' '' O
wuauserv NN O
'' '' O
, , O
the DT O
legitimate JJ O
Windows NNP O
Update NNP O
service NN O
, , O
in IN O
the DT O
given VBN O
binary JJ O
's POS O
default NN O
configuration NN O
. . O

4 CD O
. . O

Adds NNP B-Action
itself PRP B-Entity
to TO B-Modifier
list NN B-Entity
of IN I-Entity
services NNS I-Entity
started VBN I-Entity
by IN I-Entity
'netsvc NN I-Entity
' '' I-Entity
using VBG B-Modifier
the DT B-Entity
service NN I-Entity
name NN I-Entity
'helpsvc NN I-Entity
' '' I-Entity
. . O

5 CD O
. . O

If IN O
McAfee NNP O
AV NNP O
is VBZ O
installed VBN O
, , O
creates VBZ B-Action
a DT B-Entity
copy NN I-Entity
of IN I-Entity
regsvr32.exe NN I-Entity
named VBN I-Entity
Update.exe NN I-Entity
and CC O
then RB O
schedules NNS B-Action
the DT B-Entity
copy NN I-Entity
to TO B-Modifier
be VB B-Entity
deleted VBN I-Entity
on IN I-Entity
reboot NN I-Entity
using VBG B-Modifier
the DT B-Entity
well RB I-Entity
documented VBN I-Entity
MoveFileExA NN I-Entity
API NN I-Entity
. . O

6 CD O
. . O

It PRP O
then RB O
calls VBZ O
either CC O
the DT O
original JJ O
or CC O
copy NN O
of IN O
regsvr32.exe NN O
with IN O
the DT O
parameters NNS O
/s FW O
/u FW O
and CC O
the DT O
path NN O
to TO O
the DT O
copy NN O
of IN O
itself PRP O
it PRP O
made VBD O
in IN O
Step NN O
1 CD O
. . O

The DT O
/u NN O
parameter NN O
means VBZ O
'' '' O
uninstall JJ O
'' '' O
, , O
which WDT O
calls VBZ O
DllUnregisterServer NNP O
, , O
this DT O
is VBZ O
an DT O
unsophisticated JJ O
method NN O
of IN O
DLL NNP O
entry NN O
point NN O
obfuscation NN O
. . O

7 CD O
. . O

DllUnregisterServer NNP O
installs VBZ O
the DT O
driver NN O
and CC O
initiates VBZ O
the DT O
backdoor JJ O
component NN O
. . O

The DT B-Entity
sample NN I-Entity
is VBZ O
capable JJ O
of IN O
'dropping VBG B-Action
' '' I-Action
an DT B-Entity
embedded/encrypted JJ I-Entity
kernel NN I-Entity
driver NN I-Entity
. . O

If IN O
the DT O
process NN O
'' '' O
ZhuDongFangYu NN O
. . O

exe NN O
'' '' O
is VBZ O
running VBG O
( FW O
AntiVirus360 FW O
program NN O
from IN O
the DT O
Chinese JJ O
'Quihoo NN O
360 CD O
Technology NNP O
Co. NNP O
, , O
LTD NNP O
' POS O
360 CD O
) CD O
, , O
or CC O
the DT O
username NN O
of IN O
the DT O
DLL NNP O
's POS O
host NN O
process NN O
context NN O
is VBZ O
not RB O
'SYSTEM NN O
' '' O
, , O
the DT O
driver NN O
is VBZ O
not RB O
written VBN O
to TO O
disk NN O
. . O

Barring VBG O
the DT O
two CD O
aforementioned JJ O
conditions NNS O
, , O
the DT O
sample NN O
decrypts VBZ O
the DT O
kernel NN O
driver NN O
to TO O
: : O
Following VBG O
the DT O
decryption NN O
and CC O
writing NN B-Action
of IN O
the DT B-Entity
driver NN I-Entity
to TO B-Modifier
disk NN B-Entity
, , O
it PRP B-Entity
is VBZ B-Action
loaded VBN I-Action
using VBG B-Modifier
the DT B-Entity
ZwLoadDriver NNP I-Entity
( NNP I-Entity
) NNP I-Entity
API NNP I-Entity
. . O

The DT B-Entity
driv- FW I-Entity
er FW I-Entity
is VBZ B-Action
encrypted VBN I-Action
with IN B-Modifier
a DT B-Entity
simple JJ I-Entity
four CD I-Entity
byte NN I-Entity
XOR NN I-Entity
key JJ I-Entity
value NN I-Entity
of IN I-Entity
0x2E885Df3 NN I-Entity
; : O
after IN O
decryption NN O
the DT O
file NN O
has VBZ O
the DT O
MD5 NN O
hash NN O
of IN O
dae6b9b3b8e39b08b10a51a6457444d8 NN O
. . O

The DT O
malware NN O
contains VBZ O
a DT O
dynamic JJ O
configuration NN O
stored VBN O
in IN O
the DT O
Registry NNP O
under IN O
and CC O
loads NNS O
a DT O
default NN O
configuration NN O
embedded VBD O
into IN O
the DT O
binary JJ O
if IN O
such PDT O
a DT O
configuration NN O
is VBZ O
not RB O
found VBN O
. . O

The DT O
way NN O
this DT O
default NN O
configuration NN O
is VBZ O
loaded VBN O
and CC O
parsed VBN O
indicates VBZ O
that IN O
this DT O
malware NN O
has VBZ O
been VBN O
built VBN O
with IN O
a DT O
'builder NN O
' '' O
that WDT O
takes VBZ O
a DT O
template NN O
sample NN O
and CC O
lets VBZ O
an DT O
unsophisticated JJ O
user NN O
specify VB O
a DT O
configuration NN O
without IN O
recompiling VBG O
any DT O
code NN O
. . O

If IN O
the DT O
current JJ O
service NN O
name NN O
matches VBZ O
a DT O
set NN O
of IN O
pre-defined JJ O
service NN O
names NNS O
that WDT O
legitimately RB O
exist VBP O
in IN O
Windows NNP O
, , O
the DT B-Entity
backdoor NN I-Entity
then RB O
loads NNS B-Action
the DT B-Entity
original JJ I-Entity
service NN I-Entity
's POS I-Entity
DLL NNP I-Entity
into IN B-Modifier
the DT B-Entity
address NN I-Entity
space NN I-Entity
with IN B-Modifier
LoadLibrary NN B-Entity
and CC O
invokes VBZ O
the DT O
ServiceMain NNP O
export NN O
. . O

This DT O
effectively RB O
hijacks VBZ O
the DT O
original JJ O
service NN O
's POS O
entry NN O
while IN O
retaining VBG O
its PRP$ O
functionality NN O
. . O

While IN O
there EX O
is VBZ O
code NN O
in IN O
the DT O
binary JJ O
that WDT O
allows VBZ O
downloading VBG B-Action
a DT B-Entity
list NN I-Entity
of IN I-Entity
C2 NN I-Entity
servers NNS I-Entity
from IN B-Modifier
an DT B-Entity
HTTP NN I-Entity
URL NN I-Entity
, , O
the DT B-Entity
default NN I-Entity
configuration NN I-Entity
present NN I-Entity
specifies VBZ B-Action
202.86.190.3:80 CD B-Entity
as IN B-Modifier
a DT B-Entity
C2 NN I-Entity
to TO B-Modifier
use VB B-Entity
, , O
this DT O
is VBZ O
the DT O
same JJ O
Hong NNP O
Kong NNP O
C2 NN O
server NN O
as IN O
the DT O
one CD O
used VBN O
by IN O
the DT O
post NN O
exploitation NN O
.NET NN O

tool NN O
. . O

The DT B-Entity
malware NN I-Entity
has VBZ B-Action
three CD B-Entity
distinct JJ I-Entity
C2 NN I-Entity
protocols NNS I-Entity
two CD O
of IN O
which WDT O
can MD O
be VB O
transmitted VBN O
over IN O
HTTP NN O
proxies NNS O
and CC O
one PRP O
can MD O
be VB O
bundled VBN O
in IN O
two CD O
different JJ O
'dual NN O
' '' O
modes NNS O
( RB O
see VBP O
3 CD O
. . O

) NN O
, , O
totaling VBG O
7 CD O
distinct JJ O
supported VBN O
C2 NN O
mechanisms NNS O
. . O

The DT B-Entity
con- NN I-Entity
figuration NN I-Entity
contains VBZ B-Action
the DT B-Entity
C2 NN I-Entity
protocol NN I-Entity
to TO I-Entity
be VB I-Entity
used VBN I-Entity
or CC O
optionally RB O
a DT O
self-configuration NN O
mode NN O
in IN O
which WDT O
the DT B-Entity
malware NN I-Entity
attempts VBZ B-Action
the DT B-Entity
different JJ I-Entity
C2 NN I-Entity
protocols NNS I-Entity
in IN B-Modifier
a DT B-Entity
pre-defined JJ I-Entity
order NN I-Entity
. . O

In IN O
self-configuration NN O
, , O
a DT O
connection NN O
via IN O
a DT O
proxy NN O
is VBZ O
attempted VBN O
if IN O
the DT O
system NN O
wide JJ O
Internet NNP O
Explorer NNP O
settings NNS O
specify VBP O
such JJ O
a DT O
proxy NN O
. . O

The DT O
configuration NN O
found VBN O
in IN O
this DT O
sample NN O
is VBZ O
set VBN O
to TO O
automatic JJ O
self-configuration NN O
, , O
resulting VBG O
in IN O
the DT O
following JJ O
mechanisms NNS O
being VBG O
tried VBN O
in IN O
this DT O
order NN O
: : O
1 CD O
. . O

Proprietary JJ O
binary JJ O
header NN O
( NN O
optionally RB O
over IN O
an DT O
HTTP NNP O
Proxy NNP O
using VBG O
CONNECT NNP O
mechanism NN O
) NN O
; : O
this DT O
protocol NN O
consists VBZ O
of IN O
64 CD B-Entity
random JJ I-Entity
bytes NNS I-Entity
being VBG B-Action
sent VBN I-Action
to TO B-Modifier
the DT B-Entity
C2 NN I-Entity
. . O

The DT O
C2 NN O
then RB O
responds VBZ O
with IN O
64 CD O
bytes NNS O
where WRB O
the DT O
first JJ O
four CD O
bytes NNS O
must MD O
match VB O
the DT O
first JJ O
four CD O
sent VBN O
bytes NNS O
to TO O
establish VB O
a DT O
connection NN O
successfully RB O
. . O

The DT O
remaining VBG O
bytes NNS O
are VBP O
discarded VBN O
. . O

Interestingly RB O
, , O
the DT O
malware NN O
stores NNS O
the DT O
first JJ O
four CD O
bytes NNS O
rotated VBN O
right RB O
by IN O
seven CD O
bits NNS O
and CC O
compares VBZ O
that IN O
value NN O
to TO O
the DT O
seven CD O
bits NNS O
rotated VBD O
right JJ O
version NN O
of IN O
the DT O
server NN O
's POS O
response NN O
, , O
effectively RB O
neutralizing VBG O
the DT O
rotation NN O
's POS O
effect NN O
; : O
the DT O
purpose NN O
of IN O
this DT O
is VBZ O
unclear JJ O
. . O

2 CD O
. . O

A DT O
long-running JJ O
HTTP NN O
POST NN O
request NN O
to TO O
the DT O
path NN O
'' '' O
/forum/login.cgi NN O
'' '' O
with IN O
a DT O
statically RB O
defined VBN O
HTTP NN O
request NN O
string NN O
including VBG O
HTTP NN O
headers NNS O
( VBP O
optionally RB O
over IN O
a DT O
HTTP NNP O
Proxy NNP O
using VBG O
CONNECT NNP O
) NNP O
. . O

The DT O
malware NN O
requires VBZ O
the DT O
response NN O
to TO O
start VB O
with IN O
'' '' O
HTTP/1.0 NN O
200 CD O
'' '' O
or CC O
'' '' O
HTTP/1.1 NN O
200 CD O
'' '' O
and CC O
an DT O
absence NN O
of IN O
a DT O
'' '' O
Connection NN O
: : O
close JJ O
'' '' O
header NN O
. . O

This DT O
one CD O
HTTP NNP O
connection NN O
will MD O
be VB O
used VBN O
for IN O
bi-directional JJ O
communications NNS O
, , O
sending VBG B-Action
chunks NNS B-Entity
of IN I-Entity
POST NN I-Entity
payload NN I-Entity
and CC O
receiving VBG B-Action
chunks NNS B-Entity
of IN I-Entity
the DT I-Entity
response NN I-Entity
, , O
interleaved VBN O
. . O

3 CD O
. . O

Two CD O
long-running JJ O
HTTP NN O
requests NNS O
to TO O
the DT O
same JJ O
C2 NN O
( NN O
optionally RB O
over IN O
an DT O
HTTP NNP O
Proxy NNP O
with IN O
original JJ O
request NN O
verb VBP O
) CD O
, , O
one CD O
GET VBP O
request NN O
to TO O
'' '' O
/Photos/Query.cgi VB O
? . O
loginid= NN O
'' '' O
followed VBN O
by IN O
a DT O
random JJ O
number NN O
and CC O
one CD O
POST NN O
request NN O
to TO O
'' '' O
/Catelog/login1.cgi NN O
'' '' O
. . O

The DT B-Entity
GET VBP I-Entity
request NN I-Entity
serves VBZ B-Action
as IN B-Modifier
a DT B-Entity
down-stream NN I-Entity
channel NN I-Entity
while IN O
the DT B-Entity
POST NN I-Entity
request NN I-Entity
serves VBZ B-Action
as IN B-Modifier
a DT B-Entity
upstream JJ I-Entity
channel NN I-Entity
. . O

This DT O
demonstrates VBZ O
an DT O
attempt NN O
to TO O
use VB O
the DT O
most RBS O
efficient JJ O
communication NN O
channel NN O
first RB O
, , O
falling VBG O
back RB O
to TO O
more RBR O
legitimate JJ O
appearing VBG O
channels NNS O
as IN O
required VBN O
in IN O
order NN O
to TO O
appear VB O
Request NNP O
For IN O
Comment NN O
( NN O
RFC NN O
) NN O
compliant JJ O
with IN O
the DT O
HTTP NN O
protocol NN O
. . O

Additionally RB O
, , O
the DT B-Entity
malware NN I-Entity
contains VBZ B-Action
a DT B-Entity
custom NN I-Entity
DNS NN I-Entity
client NN I-Entity
implementation NN I-Entity
that WDT O
will MD O
use VB B-Action
the DT B-Entity
system NN I-Entity
's POS I-Entity
configured VBN I-Entity
DNS NN I-Entity
server NN I-Entity
to TO O
tunnel NN B-Action
C2 NN B-Entity
traffic NN I-Entity
over IN B-Modifier
legitimate JJ B-Entity
DNS NNS I-Entity
. . O

Since IN O
this DT O
C2 NN O
mechanism NN O
is VBZ O
not RB O
attempted VBN O
in IN O
self-configuration NN O
and CC O
was VBD O
not RB O
configured VBN O
for IN O
this DT O
binary JJ O
, , O
analysis NN O
was VBD O
left VBN O
out RP O
due JJ O
to TO O
time NN O
constraints NNS O
. . O

After IN O
establishing VBG O
any DT O
of IN O
the DT O
aforementioned JJ O
channels NNS O
for IN O
arbitrary JJ O
binary JJ O
data NNS O
exchange NN O
, , O
the DT B-Entity
malware NN I-Entity
will MD O
start VB O
sending VBG B-Action
and CC O
receiving VBG B-Action
compressed VBN B-Entity
binary JJ I-Entity
blobs NNS I-Entity
via IN B-Modifier
the DT B-Entity
channel NN I-Entity
of IN I-Entity
choice NN I-Entity
. . O

The DT O
C2 NN O
's POS O
binary JJ O
data NN O
blobs NNS O
are VBP O
compressed VBN O
. . O

No DT O
further JJ O
encryption NN O
of IN O
the DT O
data NN O
takes VBZ O
place NN O
. . O

All DT O
C2 NN O
transport NN O
implementations NNS O
contain VBP O
code NN O
for IN O
accepting VBG O
and CC O
handling VBG O
server-side JJ O
connections NNS O
of IN O
the DT O
respective JJ O
protocols NNS O
. . O

However RB O
, , O
this DT O
code NN O
does VBZ O
not RB O
appear VB O
to TO O
be VB O
invoked VBN O
. . O

It PRP O
appears VBZ O
that IN O
the DT O
author NN O
of IN O
this DT O
code NN O
shares VBZ O
the DT O
library NN O
that WDT O
implements VBZ O
these DT O
transports NNS O
for IN O
the DT O
client NN O
with IN O
the DT O
C2 NN O
server NN O
. . O

The DT B-Entity
main JJ I-Entity
backdoor JJ I-Entity
thread NN I-Entity
then RB O
reads VBZ B-Action
commands NNS B-Entity
from IN B-Modifier
the DT B-Entity
chosen VBN I-Entity
C2 NN I-Entity
protocol NN I-Entity
and CC O
passes VBZ O
them PRP O
on RP O
to TO O
any DT O
of IN O
the DT O
following JJ O
registered JJ O
handler NN O
classes NNS O
based VBN O
upon IN O
a DT O
command NN O
ID NN O
. . O

The DT O
handler NN O
class NN O
is VBZ O
responsible JJ O
for IN O
parsing VBG O
the DT O
remainder NN O
of IN O
the DT O
command NN O
. . O

This DT B-Entity
handler NN I-Entity
class NN I-Entity
for IN I-Entity
command NN I-Entity
ID NN I-Entity
8 CD I-Entity
implements VBZ B-Action
generic JJ B-Entity
directory NN I-Entity
and CC I-Entity
file NN I-Entity
browsing NN I-Entity
using VBG B-Modifier
FindFirstFileW FW B-Entity
( FW I-Entity
) NN I-Entity
and CC I-Entity
FindNextFileW NN I-Entity
( FW I-Entity
) FW I-Entity
APIs NNS I-Entity
, , O
as RB O
well RB O
as IN O
reading VBG B-Action
and CC O
writing VBG B-Action
arbitrary JJ B-Entity
files NNS I-Entity
via IN B-Modifier
C2 NN B-Entity
commands NNS I-Entity
, , O
thus RB O
enabling VBG O
upload NN B-Action
and CC O
download NN B-Action
of IN O
arbitrary JJ B-Entity
files NNS I-Entity
. . O

This DT O
is VBZ O
typically RB O
seen VBN O
in IN O
RATs NNS B-Entity
for IN O
searching VBG B-Action
specific JJ B-Entity
files NNS I-Entity
to TO O
exfiltrate VB B-Action
. . O

Additionally RB O
, , O
this DT B-Entity
class NN I-Entity
implements VBZ O
launching NN B-Action
of IN O
specified JJ B-Entity
executable JJ I-Entity
files NNS I-Entity
via IN B-Modifier
the DT B-Entity
CreateProcess NNP I-Entity
( NNP I-Entity
) NNP I-Entity
API NNP I-Entity
. . O

This DT B-Entity
handler NN I-Entity
class NN I-Entity
implements VBZ B-Action
a DT B-Entity
generic JJ I-Entity
TCP NN I-Entity
proxy NN I-Entity
. . O

It PRP B-Entity
supports VBZ O
establishing VBG B-Action
TCP NNP B-Entity
connections NNS I-Entity
to TO B-Modifier
other JJ B-Entity
hosts NNS I-Entity
and CC O
also RB O
listening VBG B-Action
for IN B-Modifier
incoming JJ B-Entity
connections NNS I-Entity
. . O

The DT B-Entity
incoming JJ I-Entity
connection NN I-Entity
contents NNS I-Entity
are VBP B-Action
forwarded VBN I-Action
to TO B-Modifier
the DT B-Entity
C2 NN I-Entity
and CC O
data NNS B-Entity
from IN I-Entity
the DT I-Entity
C2 NN I-Entity
is VBZ B-Action
passed VBN I-Action
on RP B-Modifier
to TO I-Modifier
connections NNS B-Entity
. . O

It PRP O
supports VBZ O
up IN O
to TO O
1024 CD O
parallel JJ O
connections NNS O
. . O

The DT B-Entity
malware NN I-Entity
is VBZ O
capable JJ O
of IN O
gathering VBG B-Action
various JJ B-Entity
pieces NNS I-Entity
of IN I-Entity
information NN I-Entity
from IN B-Modifier
the DT B-Entity
system NN I-Entity
, , O
triggered VBN O
by IN O
a DT O
command NN O
ID NN O
10 CD O
. . O

The DT O
capabilities NNS O
include VBP O
recovering VBG B-Action
authentication NN B-Entity
credentials NNS I-Entity
from IN B-Modifier
various JJ B-Entity
system NN I-Entity
and CC I-Entity
client NN I-Entity
storage NN I-Entity
such JJ I-Entity
as IN I-Entity
Mozilla NNP I-Entity
Firefox NNP I-Entity
, , I-Entity
Internet NNP I-Entity
Explorer NNP I-Entity
, , I-Entity
and CC I-Entity
Remote JJ I-Entity
Access NN I-Entity
Service NNP I-Entity
( NNP I-Entity
RAS NNP I-Entity
) NNP I-Entity
. . O

This DT B-Entity
class NN I-Entity
also RB O
supports VBZ O
gathering NN B-Action
intelligence NN B-Entity
on IN I-Entity
the DT I-Entity
infected JJ I-Entity
system NN I-Entity
including VBG O
identifying VBG B-Action
security NN B-Entity
tools NNS I-Entity
by IN B-Modifier
their PRP$ B-Entity
process NN I-Entity
name NN I-Entity
, , O
proxy NN B-Entity
accounts NNS I-Entity
, , O
and CC O
version NN B-Entity
numbers NNS I-Entity
for IN I-Entity
the DT I-Entity
Operating NNP I-Entity
System NNP I-Entity
( NNP I-Entity
OS NNP I-Entity
) NNP I-Entity
and CC O
Internet NNP B-Entity
Explorer NNP I-Entity
. . O

This DT B-Entity
handler NN I-Entity
class NN I-Entity
provides VBZ O
the DT O
attacker NN O
with IN O
the DT O
ability NN O
to TO O
manage VB B-Action
system NN B-Entity
components NNS I-Entity
including VBG O
start VB B-Action
/ / O
stop VB B-Action
/ / O
delete VB B-Action
system NN B-Entity
services NNS I-Entity
, , O
enumerate VB B-Action
/ / O
alter VB B-Action
registry NN B-Entity
keys NNS I-Entity
, , O
and CC O
manage VB B-Action
running VBG B-Entity
processes NNS I-Entity
. . O

This DT B-Entity
class NN I-Entity
also RB O
provides VBZ O
the DT O
ability NN O
for IN O
the DT O
attacker NN O
to TO O
take VB B-Action
a DT B-Entity
screen NN I-Entity
shot NN I-Entity
of IN I-Entity
the DT I-Entity
users NNS I-Entity
desktop NN I-Entity
. . O

This DT B-Entity
handler NN I-Entity
class NN I-Entity
uses VBZ O
the DT O
command NN O
ID NN O
5 CD O
and CC O
implements VBZ B-Action
an DT B-Entity
interactive JJ I-Entity
command NN I-Entity
line NN I-Entity
shell NN I-Entity
accessible JJ I-Entity
from IN I-Entity
the DT I-Entity
C2 NN I-Entity
server NN I-Entity
, , O
containing VBG O
a DT O
series NN O
of IN O
built-in JJ O
commands NNS O
. . O

If IN O
the DT O
input NN O
is VBZ O
not RB O
in IN O
this DT O
list NN O
of IN O
built-in JJ O
commands NNS O
, , O
the DT B-Entity
malware NN I-Entity
attempts VBZ O
to TO O
invoke VB B-Action
cmd.exe NN B-Entity
in IN B-Modifier
the DT B-Entity
background NN I-Entity
, , O
launching VBG B-Action
a DT B-Entity
command NN I-Entity
or CC I-Entity
command NN I-Entity
line NN I-Entity
utility NN I-Entity
already RB I-Entity
present JJ I-Entity
on IN I-Entity
the DT I-Entity
system NN I-Entity
. . O

The DT B-Entity
standard JJ I-Entity
output NN I-Entity
channel NN I-Entity
of IN I-Entity
that DT I-Entity
command NN I-Entity
is VBZ B-Action
provided VBN I-Action
back RB B-Modifier
to TO I-Modifier
the DT B-Entity
C2 NN I-Entity
. . O

The DT O
supported VBN O
built-in JJ O
commands NNS O
are VBP O
: : O
The DT O
only JJ O
command NN O
that WDT O
is VBZ O
implemented VBN O
directly RB O
in IN O
the DT O
main JJ O
backdoor JJ O
thread NN O
as IN O
a DT O
subprocedure NN O
call NN O
and CC O
not RB O
via IN O
a DT O
generic JJ O
command NN O
handler NN O
class NN O
is VBZ O
command NN O
ID NN O
256 CD O
. . O

This DT O
command NN O
results VBZ O
in IN O
the DT B-Entity
DLL NNP I-Entity
deleting VBG B-Action
itself PRP B-Entity
and CC O
terminating VBG B-Action
the DT B-Entity
backdoor JJ I-Entity
process NN I-Entity
. . O

This DT O
sample NN O
is VBZ O
a DT O
packed JJ O
32-bit JJ O
kernel NN O
driver NN O
extracted VBN O
by IN O
the DT O
aforementioned JJ O
DLL NN O
with IN O
an DT O
MD5 NN O
hash NN O
of IN O
: : O
de7500fc1065a081180841f32f06a537 NN O
, , O
this DT O
sample NN O
will MD O
only RB O
function VB O
on IN O
a DT O
Windows NNP O
32-bit JJ O
kernel NN O
. . O

This DT O
code NN O
appears VBZ O
to TO O
have VB O
been VBN O
compiled VBN O
on IN O
Sunday NNP O
October NNP O
9 CD O
, , O
2011 CD O
at IN O
4:50:31 CD O
P.M. NNP O
UTC NNP O
( NNP O
very RB O
early JJ O
morning NN O
time NN O
of IN O
Monday NNP O
, , O
October NNP O
10 CD O
in IN O
China NNP O
) NNP O
. . O

This DT O
section NN O
describes VBZ O
how WRB O
the DT O
driver NN O
performs VBZ O
its PRP$ O
initialization NN O
routine NN O
. . O

The DT B-Entity
driver NN I-Entity
begins VBZ O
by IN O
opening VBG B-Action
a DT B-Entity
named VBN I-Entity
event NN I-Entity
in IN B-Modifier
the DT B-Entity
BaseNamedObjects NNS I-Entity
object VBP I-Entity
directory NN I-Entity
with IN B-Modifier
the DT B-Entity
name NN I-Entity
{ NNP I-Entity
8CB2ff21-0166-4cf1-BD8F-E190BC7902DC NNP I-Entity
} NNP I-Entity
using VBG B-Modifier
the DT B-Entity
Windows NNP I-Entity
API NNP I-Entity
ZwOpenEvent NNP I-Entity
( NNP I-Entity
) NNP I-Entity
. . O

If IN O
the DT O
event NN O
already RB O
exists VBZ O
, , O
the DT B-Entity
driver NN I-Entity
fails VBZ O
to TO O
load VB O
, , O
presumably RB O
to TO O
avoid VB B-Action
a DT O
multiple JJ B-Entity
instances NNS I-Entity
of IN I-Entity
itself PRP I-Entity
. . O

If IN O
the DT O
event NN O
does VBZ O
not RB O
exist VB O
, , O
the DT B-Entity
driver NN I-Entity
then RB O
creates VBZ B-Action
it PRP B-Entity
using VBG B-Modifier
the DT B-Entity
Windows NNP I-Entity
API NNP I-Entity
ZwCreateEvent NNP I-Entity
( NNP I-Entity
) NNP I-Entity
. . O

The DT O
Windows NNP O
API NNP O
for IN O
creating VBG O
events NNS O
( NNP O
ZwCreateEvent NNP O
( NNP O
) NNP O
, , O
or CC O
CreateEvent FW O
( FW O
) NN O
in IN O
user NN O
mode NN O
) NN O
already RB O
provides VBZ O
the DT O
ability NN O
to TO O
'' '' O
create-or-open JJ O
'' '' O
an DT O
event NN O
, , O
so IN O
the DT O
use NN O
of IN O
an DT O
initial JJ O
ZwOpenEvent NN O
is VBZ O
superfluous JJ O
and CC O
indicative JJ O
of IN O
relatively RB O
limited JJ O
Windows NNP O
API NNP O
knowledge NN O
of IN O
the DT O
author NN O
of IN O
that DT O
part NN O
of IN O
the DT O
code NN O
. . O

It PRP O
is VBZ O
interesting JJ O
to TO O
note VB O
that IN O
some DT O
of IN O
the DT O
hex NN O
digits NNS O
in IN O
the DT O
object NN O
name NN O
are VBP O
mixed JJ O
case NN O
which WDT O
is VBZ O
potentially RB O
indicative JJ O
of IN O
the DT O
code NN O
being VBG O
re-appropriated JJ O
from IN O
another DT O
source NN O
. . O

The DT B-Entity
second JJ I-Entity
component NN I-Entity
of IN I-Entity
the DT I-Entity
entry NN I-Entity
point NN I-Entity
performs VBZ B-Action
an DT B-Entity
anti-debugging JJ I-Entity
technique NN I-Entity
, , O
calling VBG B-Action
the DT B-Entity
function NN I-Entity
KdDisableDebugger NNP I-Entity
( NNP I-Entity
) NNP I-Entity
, , O
which WDT O
allows VBZ O
the DT B-Entity
driver NN I-Entity
to TO O
disable VB B-Action
usage NN B-Entity
of IN I-Entity
the DT I-Entity
built-in JJ I-Entity
Windows NNP I-Entity
kernel NN I-Entity
debugging NN I-Entity
facility NN I-Entity
that WDT I-Entity
is VBZ I-Entity
used VBN I-Entity
by IN I-Entity
popular JJ I-Entity
kernel NN I-Entity
debuggers NNS I-Entity
KD NN I-Entity
and CC I-Entity
WinDbg NNP I-Entity
. . O

Tools NNS O
such JJ O
as IN O
Syser NNP O
Debugger NNP O
, , O
or CC O
debugging VBG O
through IN O
a DT O
virtual JJ O
machine NN O
are VBP O
unaffected JJ O
by IN O
this DT O
technique NN O
. . O

The DT O
sample NN O
, , O
rather RB O
than IN O
importing VBG O
the DT O
KdDisableDebugger NNP O
( NNP O
) NNP O
API NNP O
using VBG O
conventional JJ O
methods NNS O
, , O
looks VBZ O
up RP O
the DT O
API NNP O
through IN O
MmGetSystemRoutineAddress NNP O
( NNP O
) NNP O
instead RB O
. . O

All DT O
of IN O
the DT O
other JJ O
APIs NNS O
used VBN O
by IN O
the DT O
driver NN O
are VBP O
imported VBN O
normally RB O
, , O
so IN O
this DT O
is VBZ O
not RB O
a DT O
technique NN O
to TO O
hide VB O
import NN O
APIs NNS O
used VBN O
throughout IN O
the DT O
driver NN O
. . O

Searching NN O
Google NNP O
for IN O
'' '' O
MmGetSystemRoutineAddress NNP O
'' '' O
and CC O
'' '' O
KdDisableDebugger NNP O
'' '' O
results VBZ O
in IN O
dozens NNS O
of IN O
Chinese JJ O
language NN O
blogs NNS O
which WDT O
explain VBP O
how WRB O
to TO O
use VB O
this DT O
technique NN O
to TO O
'' '' O
Disable NNP O
WinDbg NNP O
'' '' O
. . O

The DT B-Entity
final JJ I-Entity
step NN I-Entity
of IN I-Entity
the DT I-Entity
entry NN I-Entity
point NN I-Entity
is VBZ O
to TO O
begin VB O
hooking VBG B-Action
the DT B-Entity
system NN I-Entity
, , O
which WDT O
is VBZ O
done VBN O
by IN O
two CD O
helper NN O
functions NNS O
- : O
one CD B-Entity
is VBZ O
designed VBN O
to TO O
hook NN B-Action
the DT B-Entity
system NN I-Entity
call NN I-Entity
table NN I-Entity
, , O
while IN O
the DT B-Entity
other JJ I-Entity
hooks NNS B-Action
the DT B-Entity
network NN I-Entity
stack VB I-Entity
. . O

The DT B-Entity
network NN I-Entity
stack VBP I-Entity
hooking VBG I-Entity
first RB O
queries VBZ B-Action
the DT B-Entity
OS NN I-Entity
version NN I-Entity
using VBG B-Modifier
RtlGetVersion NNP B-Entity
( NNP I-Entity
) NNP I-Entity
or CC I-Entity
PsGetVersion NNP I-Entity
( FW I-Entity
) FW I-Entity
. . O

Checking VBG O
the DT O
version NN O
is VBZ O
necessary JJ O
because IN O
Windows NNP O
versions NNS O
beginning VBG O
with IN O
Vista NNP O
utilize VBP O
a DT O
redesigned VBN O
TCP/IP NN O
net- NN O
work NN O
stack VBP O
, , O
most JJS O
hooking VBG O
operations NNS O
will MD O
require VB O
a DT O
different JJ O
implementation NN O
for IN O
these DT O
versions NNS O
. . O

On IN O
versions NNS O
prior RB O
to TO O
Windows NNP O
Vista NNP O
, , O
the DT O
TCP/IP NN O
driver NN O
creates VBZ O
a DT O
\Device\Tcp NN O
device NN O
object NN O
through IN O
which WDT O
most JJS O
network NN O
requests NNS O
are VBP O
piped VBN O
through IN O
. . O

On IN O
Vista NNP O
and CC O
later RB O
, , O
TCP/IP NN O
has VBZ O
been VBN O
split VBN O
up RP O
into IN O
multiple JJ O
components NNS O
, , O
and CC O
IP NNP O
connection NN O
enumeration NN O
, , O
which WDT O
this DT O
driver NN O
is VBZ O
targeting VBG O
, , O
is VBZ O
managed VBN O
by IN O
\Device\nsiproxy NN O
instead RB O
. . O

In IN O
either DT O
case NN O
, , O
the DT B-Entity
driver NN I-Entity
obtains VBZ O
the DT O
device NN O
object NN O
by IN O
using VBG O
IoGetDeviceObjectPointer NNP O
( FW O
) FW O
and CC O
hooks VBZ B-Action
Major JJ B-Entity
Function NN I-Entity
14 CD I-Entity
the DT I-Entity
IRPMJDEVICECONTROL NN I-Entity
, , O
as IN O
this DT O
is VBZ O
the DT O
function NN O
through IN O
which WDT O
all DT O
Input NNP O
Output NN O
ConTroLls NNP O
( NNP O
IOCTLs NNP O
) NNP O
are VBP O
sent VBN O
, , O
such JJ O
as IN O
the DT O
IOCTL NN O
for IN O
querying VBG O
active JJ O
IP NNP O
connections NNS O
. . O

The DT O
NSI NNP O
hook NN O
, , O
targets VBZ O
IOCTL NNP O
0x12001B NNP O
, , O
which WDT O
is VBZ O
used VBN O
by IN O
NsiGetObjectAllParameters NNP O
( NNP O
) NNP O
in IN O
nsi.dll NNP O
when WRB O
users NNS O
typically RB O
run VBP O
commands NNS O
such JJ O
as IN O
netstat.exe NN O
or CC O
use VB O
any DT O
of IN O
the DT O
IP NNP O
Helper NNP O
APIs NNPS O
in IN O
iphlpapi.dll NNP O
. . O

The DT O
purpose NN O
of IN O
the DT B-Entity
hook NN I-Entity
is VBZ O
to TO O
scan VB B-Action
the DT B-Entity
list NN I-Entity
of IN I-Entity
active JJ I-Entity
connections NNS I-Entity
returned VBD I-Entity
to TO I-Entity
the DT I-Entity
user NN I-Entity
, , O
and CC O
hide VB B-Action
any DT B-Entity
such JJ I-Entity
connection NN I-Entity
currently RB I-Entity
bound VBD I-Entity
to TO I-Entity
a DT I-Entity
local JJ I-Entity
TCP NN I-Entity
port NN I-Entity
in IN I-Entity
the DT I-Entity
range NN I-Entity
between IN I-Entity
40000 CD I-Entity
and CC I-Entity
45000 CD I-Entity
. . O

The DT B-Entity
hooking VBG I-Entity
is VBZ B-Action
performed VBN I-Action
by IN B-Modifier
creating VBG B-Entity
a DT I-Entity
new JJ I-Entity
completion NN I-Entity
routine NN I-Entity
associated VBN I-Entity
with IN I-Entity
any DT I-Entity
IRPMJDEVICECONTROL NN I-Entity
IRP NN I-Entity
that WDT I-Entity
matches VBZ I-Entity
the DT I-Entity
IOCTL NNP I-Entity
, , I-Entity
attaching VBG I-Entity
to TO I-Entity
the DT I-Entity
target NN I-Entity
process NN I-Entity
, , I-Entity
performing VBG I-Entity
several JJ I-Entity
memory NN I-Entity
copies NNS I-Entity
to TO I-Entity
hide VB I-Entity
the DT I-Entity
entry NN I-Entity
, , I-Entity
and CC I-Entity
detaching VBG I-Entity
. . O

This DT O
functionality NN O
is VBZ O
nearly RB O
identical JJ O
to TO O
the DT O
code NN O
posted VBN O
by IN O
Edward NNP O
Sun NNP O
( FW O
aka FW O
cardmagic NN O
, , O
sunmy1 NN O
@ SYM O
sina.com NNP O
, , O
onlyonejazz NN O
@ IN O
hotmail.com NN O
, , O
cardcian NN O
@ IN O
mail.ustc.edu.cn NNP O
, , O
QQ NNP O
# # O
28025945 CD O
) CD O
from IN O
Hefei NNP O
, , O
Anhui NNP O
province NN O
( NNP O
Nanjing NNP O
Military NNP O
District NNP O
) NNP O
on IN O
July NNP O
8 CD O
, , O
2007 CD O
, , O
then RB O
a DT O
China-based JJ O
researcher NN O
at IN O
Trend NNP O
Micro NNP O
( NNP O
now RB O
working VBG O
at IN O
Kingsoft NNP O
Chinese NNP O
AV NNP O
Company NNP O
; : O
LinkedIn NN O
profile NN O
page NN O
: : O
http NN O
: : O
//www.linkedin.com/profile/view NN O
? . O
id=84082731 FW O
) FW O
at IN O
http NN O
: : O
//forum.eviloctal.com/viewthread.php NN O
? . O
action=printable NNP O
& CC O
tid=29604 NNP O
( NNP O
See NNP O
Appendix NNP O
G NNP O
) NNP O
. . O

CrowdStrike NNP O
has VBZ O
no DT O
information NN O
connecting VBG O
Mr. NNP O
Sun NNP O
to TO O
this DT O
intrusion NN O
activity NN O
, , O
his PRP$ O
code NN O
appears VBZ O
to TO O
have VB O
been VBN O
appropriated VBN O
by IN O
the DT O
actor NN O
to TO O
add VB O
similar JJ O
functionality NN O
to TO O
their PRP$ O
code NN O
. . O

The DT B-Entity
TCP NN I-Entity
hook NN I-Entity
works VBZ O
almost RB O
identically RB O
to TO O
the DT O
NSI NNP O
hook NN O
, , O
though IN O
instead RB O
hooking VBG B-Action
IOCTL NNP B-Entity
0x120003 NNP I-Entity
( NNP I-Entity
IOCTL NNP I-Entity
TCPQUERYINFORMATIONEX NNP I-Entity
) NNP I-Entity
. . O

This NNP O
IOCTL NNP O
has VBZ O
the DT O
exact JJ O
same JJ O
functionality NN O
as IN O
the DT O
NSI NNP O
specific JJ O
IOCTL NN O
. . O

This DT O
IOCTL NN O
was VBD O
the DT O
mechanism NN O
used VBN O
on IN O
Windows NNP O
versions NNS O
prior RB O
to TO O
Windows NNP O
Vista NNP O
. . O

This DT B-Entity
hook NN I-Entity
also RB O
filters VBZ B-Action
any DT B-Entity
connections NNS I-Entity
listening VBG I-Entity
on IN I-Entity
TCP NNP I-Entity
ports NNS I-Entity
in IN I-Entity
the DT I-Entity
range NN I-Entity
between IN I-Entity
40000 CD I-Entity
and CC I-Entity
45000 CD I-Entity
. . O

The DT O
system NN O
call NN O
hooking VBG O
targets NNS O
three CD O
functions NNS O
: : O
ZwSaveKey NNP O
( NNP O
) NNP O
, , O
ZwQueryValueKey NNP O
( NNP O
) NNP O
, , O
and CC O
ZwEnumerateValueKey NNP O
( NNP O
) NNP O
. . O

The DT B-Entity
unpacked JJ I-Entity
kernel NN I-Entity
driver NN I-Entity
sample NN I-Entity
hooks VBZ B-Action
these DT B-Entity
functions NNS I-Entity
by IN B-Modifier
reading VBG B-Entity
the DT I-Entity
second JJ I-Entity
DWORD NN I-Entity
at IN I-Entity
each DT I-Entity
of IN I-Entity
these DT I-Entity
exported VBN I-Entity
functions NNS I-Entity
. . O

Because IN O
the DT O
system NN O
call NN O
stub NN O
uses VBZ O
the DT O
EAX NN O
register NN O
as IN O
an DT O
index NN O
for IN O
the DT O
system NN O
call NN O
ID NN O
, , O
and CC O
a DT O
'' '' O
mov NN O
eax NN O
, , O
imm32 NN O
'' '' O
instruction NN O
'' '' O
instruction NN O
is VBZ O
used VBN O
, , O
this DT O
second JJ O
DWORD NNP O
will MD O
match VB O
the DT O
system NN O
call NN O
ID NN O
. . O

It PRP O
then RB O
adds VBZ O
this DT O
index NN O
to TO O
the DT O
value NN O
of IN O
KeServiceDescriptorTable.Base NN O
, , O
which WDT O
is VBZ O
the DT O
exported VBN O
kernel NN O
variable JJ O
( NN O
on IN O
32-bit JJ O
Windows NNP O
only RB O
) CD O
which WDT O
directly RB O
points VBZ O
to TO O
the DT O
system NN O
call NN O
table NN O
. . O

This DT O
is VBZ O
one CD O
of IN O
the DT O
simplest JJS O
ways NNS O
to TO O
do VB O
a DT O
system NN O
call NN O
hook NN O
, , O
but CC O
will MD O
not RB O
work VB O
on IN O
64-bit JJ O
Windows NNP O
as IN O
this DT O
variable NN O
is VBZ O
not RB O
exported VBN O
in IN O
addition NN O
to TO O
the DT O
protection NN O
provided VBN O
by IN O
Microsoft NNP O
PatchGuard NNP O
. . O

The DT B-Entity
system NN I-Entity
call NN I-Entity
hook NN I-Entity
is VBZ B-Action
then RB I-Action
performed VBN I-Action
by IN B-Modifier
first RB B-Entity
allocating VBG I-Entity
a DT I-Entity
Memory NN I-Entity
Descriptor NN I-Entity
List NN I-Entity
( CD I-Entity
MDL NN I-Entity
) NN I-Entity
using VBG I-Entity
the DT I-Entity
Windows NNP I-Entity
API NNP I-Entity
IoAllocateMdl NNP I-Entity
( NNP I-Entity
) NNP I-Entity
, , I-Entity
and CC I-Entity
associating VBG I-Entity
the DT I-Entity
MDL NN I-Entity
to TO I-Entity
a DT I-Entity
non-paged JJ I-Entity
buffer NN I-Entity
using VBG I-Entity
MmBuildMdlForNonPagedPool NNP I-Entity
( NNP I-Entity
) NNP I-Entity
. . O

Once RB O
the DT O
MDL NN O
is VBZ O
associated VBN O
to TO O
the DT O
non-paged JJ O
buffer NN O
, , O
the DT O
sample NN O
locks VBZ O
the DT O
underlying VBG O
pages NNS O
using VBG O
the DT O
Windows NNP O
API NNP O
MmProbeAndLockPages NNP O
( NNP O
) NNP O
. . O

Instead RB O
of IN O
hooking VBG O
the DT O
entry NN O
in IN O
the DT O
table NN O
directly RB O
, , O
which WDT O
is VBZ O
easily RB O
detectable JJ O
, , O
the DT B-Entity
driver NN I-Entity
uses VBZ O
the DT O
LDASM FW O
open-source FW O
disassembly NN O
engine NN O
to TO O
analyze VB O
the DT O
function NN O
that WDT O
is VBZ O
being VBG O
pointed VBN O
to TO O
by IN O
the DT O
table NN O
, , O
and CC O
applying VBG B-Action
a DT B-Entity
Detours-style JJ I-Entity
hook NN I-Entity
directly RB B-Modifier
in IN I-Modifier
the DT B-Entity
code NN I-Entity
. . O

It PRP O
uses VBZ O
the DT O
standard NN O
'' '' O
mov FW O
cr0 FW O
, , O
eax NN O
'' '' O
technique NN O
, , O
turning VBG O
off RP O
the DT O
Write NNP O
Protect NNP O
( NNP O
WP NNP O
) NNP O
bit VBD O
as IN O
it PRP O
does VBZ O
this DT O
. . O

When WRB O
the DT O
hook NN O
is VBZ O
installed VBN O
, , O
it PRP O
writes VBZ O
a DT O
special JJ O
DWORD NN O
value NN O
, , O
'KDTR NN O
' '' O
, , O
which WDT O
allows VBZ O
it PRP O
to TO O
prevent VB O
double-hooking JJ O
or CC O
badly-hooking JJ O
the DT O
system NN O
call NN O
, , O
during IN O
unhooking NN O
, , O
this DT O
value NN O
is VBZ O
also RB O
checked VBN O
. . O

In IN O
the DT O
ZwSaveKey NN O
( FW O
) FW O
hook NN O
, , O
access NN O
to TO O
\\REGISTRY\\MACHINE\\SYSTEM NN O
is VBZ O
blocked VBN O
. . O

RegSaveKey FW O
( FW O
) NN O
which WDT O
is VBZ O
the DT O
user-mode JJ O
implementation NN O
of IN O
the DT O
kernel NN O
ZwSaveKey NNP O
( NNP O
) NNP O
API NNP O
, , O
is VBZ O
typically RB O
used VBN O
when WRB O
performing VBG O
an DT O
offline JJ O
backup NN O
of IN O
a DT O
particular JJ O
registry NN O
key NN O
. . O

hook NN O
is VBZ O
the DT O
ZwQueryValueValue NNP O
( NNP O
) NNP O
hook NN O
, , O
which WDT O
looks VBZ O
for IN O
'' '' O
Parameters NNS O
'' '' O
key NN O
of IN O
a DT O
service NN O
within IN O
the DT O
registry NN O
at IN O
\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Services\\ NN O
. . O

It PRP B-Entity
then RB O
checks VBZ B-Action
for IN B-Modifier
the DT B-Entity
values NNS I-Entity
of IN I-Entity
the DT I-Entity
'' '' I-Entity
ServiceDll NNP I-Entity
'' '' I-Entity
and CC I-Entity
'' '' I-Entity
Security NNP I-Entity
'' '' I-Entity
keys NNS I-Entity
, , O
in IN O
the DT O
latter JJ O
case NN O
it PRP B-Entity
applies VBZ B-Action
an DT B-Entity
XOR NN I-Entity
on IN B-Modifier
the DT B-Entity
data NNS I-Entity
with IN B-Modifier
the DT B-Entity
value NN I-Entity
127 CD I-Entity
. . O

The DT O
user-mode JJ O
component NN O
of IN O
this DT O
malware NN O
is VBZ O
a DT O
service NN O
called VBN O
'' '' O
msupdate NN O
'' '' O
, , O
this DT B-Entity
driver NN I-Entity
is VBZ O
attempting VBG O
to TO O
hide VB B-Action
the DT B-Entity
service NN I-Entity
. . O

The DT O
user-mode JJ O
service NN O
stores NNS O
configuration NN O
data NNS O
in IN O
the DT O
'' '' O
Security NNP O
'' '' O
subkey NN O
of IN O
the DT O
RPC NNP O
registry NN O
key NN O
, , O
this DT O
component NN O
will MD O
obfuscate VB O
the DT O
user-mode JJ O
configuration NN O
data NNS O
. . O

The DT O
driver NN O
does VBZ O
not RB O
make VB O
any DT O
efforts NNS O
to TO O
hide VB O
its PRP$ O
own JJ O
key NN O
, , O
nor CC O
does VBZ O
it PRP O
specifically RB O
check VB O
for IN O
'' '' O
RPC NNP O
'' '' O
before IN O
'' '' O
Security NNP O
'' '' O
, , O
which WDT O
can MD O
lead VB O
to TO O
random JJ O
data NNS O
being VBG O
obfuscated VBN O
. . O

The DT O
final JJ O
hook NN O
, , O
ZwEnumerateValueKey NNP O
( NNP O
) NNP O
, , O
is VBZ O
similar JJ O
in IN O
structure NN O
to TO O
the DT O
ZwQueryValueHook NNP O
key NN O
, , O
due JJ O
to TO O
the DT O
fact NN O
that IN O
these DT O
APIs NNS O
provide VBP O
almost RB O
identical JJ O
functionality NN O
when WRB O
it PRP O
comes VBZ O
to TO O
reading VBG O
registry NN O
values NNS O
. . O

In IN B-Modifier
the DT B-Entity
registry NN I-Entity
hooking VBG I-Entity
code NN I-Entity
of IN I-Entity
the DT I-Entity
driver NN I-Entity
, , O
a DT B-Entity
call NN I-Entity
is VBZ B-Action
made VBN I-Action
to TO B-Modifier
ObReferenceObjectByHandle NNP B-Entity
( NNP I-Entity
) NNP I-Entity
. . O

This DT O
allows VBZ O
the DT O
driver NN O
to TO O
receive VB O
the DT O
'CMKEYOBJECT NN O
' '' O
which WDT O
is VBZ O
then RB O
used VBN O
with IN O
ObQueryNameString NNP O
( NNP O
) NNP O
to TO O
get VB O
the DT O
key/value JJ O
path NN O
. . O

However RB O
, , O
no DT O
call NN O
to TO O
ObDereferenceObject NNP O
( NNP O
) NNP O
is VBZ O
ever RB O
made VBN O
, , O
which WDT O
means VBZ O
that IN O
all DT O
registry NN O
objects NNS O
being VBG O
sent VBN O
to TO O
these DT O
APIs NNS O
are VBP O
eventually RB O
leaked VBN O
. . O

In IN O
the DT O
registry NN O
hook NN O
, , O
it PRP O
was VBD O
noticed VBN O
that IN O
'' '' O
CurrentControlSet001 NN O
'' '' O
was VBD O
used VBN O
as IN O
the DT O
target NN O
, , O
if IN O
the DT O
target NN O
machine NN O
was VBD O
using VBG O
a DT O
'' '' O
last JJ O
known JJ O
good JJ O
'' '' O
configuration NN O
, , O
or CC O
a DT O
roaming VBG O
hardware NN O
profile NN O
, , O
the DT O
registry NN O
hook NN O
would MD O
not RB O
function VB O
as IN O
intended VBN O
. . O

This DT O
is VBZ O
the DT O
reason NN O
the DT O
Microsoft NNP O
implemented VBD O
a DT O
symbolic JJ O
link NN O
to TO O
\\CurrentControlSet NN O
which WDT O
ensures VBZ O
that IN O
regardless RB O
of IN O
the DT O
machines NNS O
configuration NN O
any DT O
request NN O
will MD O
access VB O
the DT O
correct JJ O
registry NN O
key NN O
. . O

This DT O
threat NN O
actor NN O
leaves VBZ O
several JJ O
key JJ O
fingerprints NNS O
which WDT O
can MD O
be VB O
used VBN O
to TO O
identify VB O
compromised VBN O
systems NNS O
. . O

These DT O
digital JJ O
fingerprints NNS O
are VBP O
unique JJ O
to TO O
this DT O
adversary NN O
for IN O
this DT O
campaign NN O
. . O

The DT O
following VBG O
network NN O
signatures NNS O
are VBP O
designed VBN O
for IN O
the DT O
popular JJ O
Open NNP O
Source NNP O
IDS NNP O
called VBD O
Snort NNP O
. . O

These DT O
signature NN O
can MD O
be VB O
ported VBN O
to TO O
other JJ O
formats NNS O
upon IN O
request NN O
. . O

The DT O
following VBG O
file NN O
system NN O
artifacts NNS O
are VBP O
indicative JJ O
of IN O
a DT O
compromised VBN O
host NN O
: : O
The DT O
following VBG O
Windows NNP O
Registry NNP O
artifacts NNS O
are VBP O
indicative JJ O
of IN O
a DT O
compromised VBN O
host NN O
: : O
The DT O
backdoor NN O
may MD O
be VB O
detected VBN O
by IN O
several JJ O
different JJ O
Anti-Virus NNP O
products NNS O
under IN O
a DT O
signature NN O
with IN O
the DT O
name NN O
: : O
Attribution NN O
in IN O
the DT O
cyber NN O
domain NN O
is VBZ O
always RB O
a DT O
tricky JJ O
subject NN O
when WRB O
relying VBG O
solely RB O
on IN O
malicious JJ O
samples NNS O
. . O

Compiler NNP O
artifacts NNS O
and CC O
language NN O
settings NNS O
can MD O
of IN O
course NN O
be VB O
deliberately RB O
masked VBN O
or CC O
spoofed VBN O
. . O

CrowdStrike NNP O
uses VBZ O
a DT O
unique JJ O
approach NN O
of IN O
comprehensive JJ O
threat NN O
analysis NN O
in IN O
order NN O
to TO O
decipher VB O
attributable JJ O
components NNS O
. . O

Based VBN O
on IN O
the DT O
corroborating JJ O
evidence NN O
discovered VBN O
in IN O
the DT O
course NN O
of IN O
this DT O
analysis NN O
, , O
it PRP O
appears VBZ O
there EX O
are VBP O
numerous JJ O
indications NNS O
that IN O
this DT O
is VBZ O
a DT O
Chinese-speaking JJ O
actor NN O
. . O

ZhuDongFangYu.exe NN O
is VBZ O
a DT O
component NN O
of IN O
360 CD O
360 CD O
, , O
a DT O
Chinese JJ O
security NN O
product NN O
available JJ O
from IN O
http NN O
: : O
//www.360.cn/ NN O
. . O

This DT O
is VBZ O
particularly RB O
relevant JJ O
in IN O
this DT O
case NN O
because IN O
the DT B-Entity
backdoor JJ I-Entity
DLL NNP I-Entity
sample NN I-Entity
with IN I-Entity
an DT I-Entity
MD5 NN I-Entity
of IN I-Entity
de7500fc1065a081180841f32f06a537 NN I-Entity
specifically RB O
avoids VBZ B-Action
installing VBG B-Entity
the DT I-Entity
kernel NN I-Entity
driver NN I-Entity
on IN I-Entity
a DT I-Entity
system NN I-Entity
running VBG I-Entity
this DT I-Entity
tool NN I-Entity
. . O

Speculatively RB O
this DT O
may MD O
be VB O
because IN O
this DT O
security NN O
product NN O
detects VBZ O
this DT O
rootkit NN O
, , O
or CC O
the DT O
author NN O
was VBD O
attempting VBG O
to TO O
prevent VB O
accidental JJ O
infection NN O
on IN O
systems NNS O
running VBG O
this DT O
Anti-Virus NNP O
product NN O
. . O

The DT O
obfuscation NN O
of IN O
the DT O
KdDisableDebugger NN O
( FW O
) FW O
function NN O
call NN O
is VBZ O
seen VBN O
on IN O
several JJ O
Chinese JJ O
language NN O
forums NNS O
, , O
and CC O
can MD O
be VB O
seen VBN O
being VBG O
reused VBN O
in IN O
several JJ O
code NN O
samples NNS O
on IN O
those DT O
forums NNS O
. . O

As IN O
previously RB O
mentioned VBN O
there EX O
is VBZ O
no DT O
advantage NN O
associated VBN O
with IN O
using VBG O
this DT O
call NN O
obfuscation NN O
, , O
and CC O
appears VBZ O
to TO O
be VB O
reused VBN O
for IN O
no DT O
apparent JJ O
reason NN O
other JJ O
than IN O
the DT O
attackers NNS O
have VBP O
copied VBN O
code NN O
directly RB O
from IN O
forum NN O
code NN O
. . O

While IN O
the DT B-Entity
various JJ I-Entity
network NN I-Entity
hooking VBG I-Entity
techniques NNS I-Entity
used VBN B-Action
in IN B-Modifier
the DT B-Entity
kernel NN I-Entity
driver NN I-Entity
may MD O
appear VB O
novel JJ O
or CC O
well RB O
researched VBN O
, , O
upon IN O
close JJ O
inspection NN O
it PRP O
is VBZ O
actually RB O
a DT O
line-for-line JJ O
copy NN O
of IN O
an DT O
existing VBG O
post NN O
from IN O
the DT O
now-offline JJ O
'rootkit.com NN O
' '' O
by IN O
a DT O
Chinese JJ O
language NN O
developer NN O
. . O

This DT O
post NN O
is VBZ O
currently RB O
mirrored VBN O
on IN O
dozens NNS O
of IN O
Chinese JJ O
hacking NN O
websites NNS O
. . O

Similarly RB O
the DT O
system NN O
call NN O
hooking VBG O
is VBZ O
less RBR O
impressive JJ O
after IN O
searching VBG O
for IN O
'' '' O
IoAllocateMdl NNP O
'' '' O
and CC O
'' '' O
cr0 NN O
'' '' O
( FW O
bbs.pediy FW O
. . O

com/showthread.php NN O
? . O
t=77467 NN O
perform VBP B-Action
system NN B-Entity
call NN I-Entity
hooking VBG I-Entity
through IN B-Modifier
MDLs NNS B-Entity
. . O

The DT O
ldasm NN O
inline NN O
hooking VBG O
is VBZ O
also RB O
repeated VBN O
in IN O
numerous JJ O
postings NNS O
to TO O
Chinese JJ O
forums NNS O
. . O

One CD O
particular JJ O
website NN O
( FW O
http FW O
: : O
//read.pudn.com/downloads197/sourcecode/windows/sys- JJ O
tem/927802/CCRootkit/RootkitSys/HookSSDT.c.htm NN O
) NN O
had VBD O
an DT O
almost RB O
identical JJ O
ldasm NN O
loop NN O
that WDT O
tried VBD O
to TO O
identify VB O
the DT O
exact JJ O
same JJ O
code NN O
sequences NNS O
. . O

Open NNP O
source NN O
research NN O
of IN O
the DT O
4 CD O
innocuous JJ O
kernel NN O
APIs NNS O
'' '' O
ZwSaveKey NNP O
ZwQueryValueKey NNP O
ZwEnumerateValueKey NNP O
IoAllocateMdl NNP O
'' '' O
, , O
in IN O
concert NN O
leads VBZ O
directly RB O
to TO O
a DT O
Chinese JJ O
website NN O
that WDT O
has VBZ O
a DT B-Entity
cached VBN I-Entity
rootkit NN I-Entity
performing VBG B-Action
similar JJ B-Entity
hooks NNS I-Entity
on IN B-Modifier
the DT B-Entity
same JJ I-Entity
3 CD I-Entity
registry NN I-Entity
related JJ I-Entity
APIs NNS I-Entity
. . O

While IN O
the DT O
driver NN O
does VBZ O
not RB O
use VB O
pool NN O
tags NNS O
for IN O
most JJS O
of IN O
its PRP$ O
allocations NNS O
, , O
it PRP O
does VBZ O
utilize VB O
them PRP O
in IN O
the DT O
networking NN O
hooking VBG O
code NN O
, , O
much RB O
like IN O
the DT O
examples NNS O
found VBN O
on IN O
the DT O
Chinese JJ O
language NN O
forums NNS O
. . O

This DT O
sample NN O
uses VBZ O
pool NN O
tags NNS O
: : O
'tnet NN O
, , O
' '' O
and CC O
'KDTR NN O
' '' O
. . O

Although IN O
the DT O
meaning NN O
of IN O
the DT O
KDTR NN O
tag NN O
is VBZ O
not RB O
obvious JJ O
, , O
we PRP O
assess VBP O
with IN O
high JJ O
confidence NN O
that IN O
this DT O
is VBZ O
a DT O
shortened VBN O
version NN O
of IN O
: : O
'' '' O
Kernel NNP O
DeTouR NN O
'' '' O
, , O
which WDT O
coincides VBZ O
with IN O
the DT O
matching JJ O
functionality NN O
of IN O
the DT O
detour-style JJ O
inline NN O
hook NN O
. . O

The DT O
driver NN O
code NN O
( CD O
MD5 NN O
: : O
dae6b9b3b8e39b08b10a51a6457444d8 FW O
) FW O
appears VBZ O
to TO O
be VB O
a DT O
combination NN O
of IN O
various JJ O
code NN O
that WDT O
is VBZ O
easily RB O
searchable JJ O
on IN O
the DT O
Internet NN O
, , O
and CC O
almost RB O
always RB O
attributed VBN O
to TO O
Chinese JJ O
language NN O
forums NNS O
and CC O
websites NNS O
. . O

The DT O
system NN O
call NN O
hooking VBG O
parts NNS O
of IN O
the DT O
code NN O
appear VBP O
to TO O
be VB O
identical JJ O
to TO O
the DT O
HookSSDT.c NN O
code NN O
authored VBN O
by IN O
Steven NNP O
Lai NNP O
'embedlinux NN O
' '' O
and CC O
utilized VBN O
in IN O
what WP O
the DT O
author NN O
titled VBN O
'CC NNP O
Rootkit NNP O
' '' O
on IN O
on IN O
August NNP O
4 CD O
, , O
2008 CD O
who WP O
's VBZ O
email NN O
address NN O
is VBZ O
hqulyc JJ O
@ IN O
126.com NNP O
. . O

This DT O
user NN O
has VBZ O
a DT O
QQ NN O
identity NN O
of IN O
: : O
5054-3533 CD O
, , O
QQ NNP O
is VBZ O
a DT O
popular JJ O
instant NN O
messaging VBG O
chat NN O
client NN O
used VBD O
almost RB O
exclusively RB O
in IN O
China NNP O
. . O

His PRP$ O
real JJ O
name NN O
according VBG O
to TO O
his PRP$ O
QQ NN O
profile NN O
( FW O
http FW O
: : O
//user.qzone.qq.com/50543533 FW O
) FW O
appears VBZ O
to TO O
be VB O
Steven NNP O
Lai NNP O
. . O

He PRP O
was VBD O
is VBZ O
28 CD O
years NNS O
old JJ O
( NN O
born VBN O
September NNP O
5 CD O
, , O
1983 CD O
) NN O
and CC O
lives NNS O
in IN O
Xiamen NNP O
, , O
Fujian NNP O
province NN O
( NNP O
Nanjing NNP O
Military NNP O
Region NNP O
) NNP O
. . O

According VBG O
to TO O
his PRP$ O
profile NN O
, , O
he PRP O
has VBZ O
worked VBN O
at IN O
Xiamen NNP O
XOCECO NNP O
New NNP O
Technic NNP O
Co. NNP O
, , O
Ltd. NNP O
( CD O
http NN O
: : O
//www.likego.com/en/about.asp FW O
) FW O
, , O
a DT O
company NN O
that WDT O
builds VBZ O
audio/video NN O
systems NNS O
for IN O
transportation NN O
systems NNS O
. . O

Mr. NNP O
Lai NNP O
is VBZ O
not RB O
being VBG O
identified VBN O
as IN O
the DT O
actor NN O
, , O
his PRP$ O
code NN O
however RB O
was VBD O
used VBN O
by IN O
whomever NN O
built VBD O
the DT O
kernel NN O
driver NN O
utilized VBN O
by IN O
the DT O
backdoor NN O
and CC O
for IN O
this DT O
reason NN O
we PRP O
are VBP O
providing VBG O
the DT O
background NN O
on IN O
this DT O
individual NN O
. . O

The DT O
samples NNS O
involved VBN O
in IN O
this DT O
incident NN O
are VBP O
typical JJ O
of IN O
attacks NNS O
commonly RB O
associated VBN O
with IN O
the DT O
People's NNP O
Republic NNP O
of IN O
China NNP O
( FW O
PRC FW O
) FW O
. . O

These DT O
code NN O
samples NNS O
have VBP O
a DT O
variety NN O
of IN O
Tools NNS O
, , O
Techniques NNS O
, , O
and CC O
Procedures NNS O
( FW O
TTPs FW O
) NN O
that WDT O
are VBP O
used VBN O
to TO O
track VB O
and CC O
identify VB O
specific JJ O
adversary NN O
groups NNS O
. . O

The DT O
sophistication NN O
of IN O
the DT O
actor NN O
responsible JJ O
this DT O
incident NN O
is VBZ O
difficult JJ O
to TO O
quantify VB O
without IN O
visibility NN O
into IN O
the DT O
activities NNS O
that WDT O
transpired VBD O
on IN O
the DT O
victims NNS O
network NN O
. . O

The DT O
ability NN O
to TO O
conduct VB O
Incident NNP O
Response NNP O
( NNP O
IR NNP O
) NNP O
including VBG O
forensics NNS O
, , O
and CC O
log NN O
analysis NN O
, , O
greatly RB O
augments VBZ O
this DT O
visibility NN O
into IN O
these DT O
aspects NNS O
of IN O
the DT O
incident NN O
. . O

Some DT O
indications NNS O
as IN O
to TO O
the DT O
adversaries NNS O
' POS O
capabilities NNS O
can MD O
be VB O
derived VBN O
from IN O
the DT O
captured VBN O
samples NNS O
alone RB O
. . O

The DT O
dropper NN O
code NN O
( CD O
MD5 NN O
: : O
14c04f88dc97aef3e9b516ef208a2bf5 FW O
) FW O
does VBZ O
not RB O
utilize VB O
any DT O
techniques NNS O
that WDT O
are VBP O
unique JJ O
or CC O
unusual JJ O
, , O
and CC O
is VBZ O
consistent JJ O
with IN O
tools NNS O
, , O
techniques NNS O
, , O
and CC O
procedures NNS O
of IN O
attacks NNS O
targeting VBG O
proprietary JJ O
information NN O
and CC O
generally RB O
attributed VBN O
to TO O
the DT O
PRC NNP O
. . O

The DT O
presence NN O
of IN O
dead JJ O
code NN O
and CC O
its PRP$ O
replacement NN O
by IN O
a DT O
more RBR O
simple JJ O
obfuscation NN O
method NN O
to TO O
hide VB O
the DT O
to-be-dropped JJ O
dll NN O
binary JJ O
file NN O
indicates VBZ O
code NN O
reuse NN O
on IN O
the DT O
attacker NN O
side NN O
. . O

The DT O
'dead NN O
code NN O
' '' O
utilizes VBZ O
a DT O
more RBR O
sophisticated JJ O
compression NN O
algorithm NN O
provided VBN O
by IN O
a DT O
third JJ O
party NN O
which WDT O
was VBD O
rendered VBN O
useless JJ O
for IN O
some DT O
reason NN O
. . O

This DT O
may MD O
have VB O
been VBN O
a DT O
result NN O
of IN O
the DT O
attacker NN O
modifying VBG O
an DT O
existing VBG O
tool NN O
, , O
or CC O
unknowingly RB O
using VBG O
a DT O
re-purposed JJ O
tool NN O
. . O

The DT O
dropper NN O
resources NNS O
indicate VBP O
the DT O
compiler NN O
used VBN O
to TO O
build VB O
the DT O
tool NN O
was VBD O
running VBG O
on IN O
a DT O
system NN O
that WDT O
utilized VBD O
the DT O
Chinese NNPS O
'' '' O
Simple JJ O
'' '' O
language NN O
pack NN O
and CC O
was VBD O
built VBN O
on IN O
Wednesday NNP O
May NNP O
4th JJ O
, , O
2011 CD O
at IN O
11:04:24 CD O
A.M. NNP O
UTC NNP O
( NNP O
early JJ O
evening NN O
time NN O
in IN O
China NNP O
) NNP O
. . O

While IN O
this DT O
can MD O
be VB O
deliberately RB O
spoofed VBN O
as IN O
a DT O
'false JJ O
flag NN O
' '' O
other JJ O
indicators NNS O
including VBG O
the DT O
C2 NN O
are VBP O
consistent JJ O
with IN O
this DT O
having VBG O
been VBN O
the DT O
work NN O
of IN O
a DT O
Chinese JJ O
speaking NN O
actor NN O
. . O

The DT B-Entity
dropped VBD I-Entity
DLL NNP I-Entity
( NNP I-Entity
MD5 NN I-Entity
: : I-Entity
47619fca20895abc83807321cbb80a3d FW I-Entity
) FW I-Entity
itself PRP I-Entity
contains VBZ B-Action
functionality NN B-Entity
that WDT I-Entity
is VBZ I-Entity
typical JJ I-Entity
of IN I-Entity
a DT I-Entity
Remote JJ I-Entity
Access NN I-Entity
Tool NNP I-Entity
( CD I-Entity
RAT NN I-Entity
) NN I-Entity
which WDT O
are VBP O
commonly RB O
used VBN B-Action
by IN O
PRC NNP B-Entity
based VBN I-Entity
actors NNS I-Entity
in IN B-Modifier
data NN B-Entity
exfiltration NN I-Entity
attacks NNS I-Entity
. . O

The DT O
code NN O
quality NN O
is VBZ O
not RB O
impressive JJ O
, , O
and CC O
contains VBZ O
a DT O
trivial JJ O
stack VB O
buffer NN O
overflow NN O
vulnerability NN O
. . O

Despite IN O
the DT O
buf- FW O
fer FW O
overflow NN O
, , O
the DT O
C2 NN O
channel NN O
lacks VBZ O
any DT O
command NN O
authenication NN O
or CC O
encryption NN O
, , O
apart RB O
from IN O
the DT O
initial JJ O
beacon NN O
encryption/obfuscation NN O
using VBG O
a DT O
statically RB O
compiled VBN O
XOR NN O
key NN O
. . O

The DT O
sample NN O
uses VBZ O
TCP NN O
port NN O
443 CD O
for IN O
commu- FW O
nication FW O
, , O
but CC O
makes VBZ O
no DT O
attempt NN O
to TO O
mimic VB O
the DT O
SSL NNP O
protocol NN O
typically RB O
used VBN O
on IN O
that DT O
port JJ O
number NN O
, , O
which WDT O
would MD O
provide VB O
enhanced VBN O
Operational NNP O
Security NNP O
( FW O
OPSEC FW O
) FW O
. . O

This DT O
code NN O
appears VBZ O
to TO O
have VB O
been VBN O
compiled VBN O
on IN O
Wednes- JJ O
day NN O
May NNP O
4th JJ O
, , O
2011 CD O
at IN O
10:48:19 CD O
A.M. NNP O
UTC NNP O
( NNP O
early JJ O
evening NN O
time NN O
in IN O
China NNP O
) NNP O
. . O

The DT O
post NN O
exploitation NN O
tool NN O
( CD O
MD5 NN O
: : O
2dce7fc3f52a692d8a84a0c182519133 FW O
) FW O
is VBZ O
a DT O
dual-use JJ O
tool NN O
, , O
it PRP B-Entity
can MD O
be VB B-Action
dropped VBN I-Action
and CC O
executed VBN B-Action
by IN O
a DT B-Entity
client-side NN I-Entity
exploit VB I-Entity
, , O
or CC O
the DT B-Entity
adversary NN I-Entity
can MD O
launch VB B-Action
it PRP B-Entity
using VBG B-Modifier
a DT B-Entity
variety NN I-Entity
of IN I-Entity
command NN I-Entity
line NN I-Entity
options NNS I-Entity
. . O

This DT O
tool NN O
is VBZ O
built VBN O
in IN O
Microsoft NNP O
.NET NNP O

framework NN O
, , O
which WDT O
is VBZ O
typically RB O
an DT O
indication NN O
of IN O
a DT O
less RBR O
sophis- JJ O
ticated JJ O
attacker NN O
, , O
because IN O
.NET NN O

is VBZ O
easier JJR O
to TO O
develop VB O
in IN O
but CC O
requires VBZ O
the DT O
.NET NN O

framework NN O
be VB O
present JJ O
on IN O
the DT O
victim NN O
machine NN O
. . O

The DT O
tool NN O
appears VBZ O
to TO O
have VB O
been VBN O
compiled VBN O
on IN O
Thursday NNP O
May NNP O
26th JJ O
, , O
2011 CD O
at IN O
10:21:44 CD O
A.M. NNP O
UTC NNP O
( NNP O
early JJ O
evening NN O
time NN O
in IN O
China NNP O
) NNP O
. . O

The DT B-Entity
sample NN I-Entity
utilizes VBZ B-Action
the DT B-Entity
AES NN I-Entity
cryptographic JJ I-Entity
algorithm NN I-Entity
to TO B-Modifier
protect VB B-Entity
its PRP$ I-Entity
C2 NN I-Entity
communications NNS I-Entity
. . O

This DT B-Entity
DLL NNP I-Entity
is VBZ B-Action
a DT B-Entity
moderately RB I-Entity
sophisticated JJ I-Entity
backdoor NN I-Entity
with IN O
several JJ O
well RB O
designed VBN O
communication NN O
mechanisms NNS O
not RB O
typically RB O
seen VBN O
in IN O
these DT O
types NNS O
of IN O
implants NNS O
. . O

The DT O
code NN O
base NN O
for IN O
the DT O
sample NN O
was VBD O
developed VBN O
in IN O
C++ NNP O
. . O

The DT O
code NN O
appears VBZ O
to TO O
have VB O
been VBN O
compiled VBN O
on IN O
Sunday NNP O
October NNP O
30 CD O
, , O
2011 CD O
at IN O
12:43:33 CD O
P.M. NNP O
UTC NNP O
( NNP O
late JJ O
evening NN O
time NN O
in IN O
China NNP O
) NNP O
. . O

This DT B-Entity
sample NN I-Entity
has VBZ B-Action
multiple JJ B-Entity
communication NN I-Entity
capabilities NNS I-Entity
available JJ I-Entity
that WDT O
makes VBZ O
it PRP O
far RB O
more RBR O
versatile JJ O
and CC O
stealthy JJ O
. . O

It PRP B-Entity
implements VBZ B-Action
relatively RB B-Entity
well RB I-Entity
thought VBN I-Entity
out RP I-Entity
protocols NNS I-Entity
including VBG I-Entity
HTTP NNP I-Entity
and CC I-Entity
DNS NNP I-Entity
. . O

The DT B-Entity
tool NN I-Entity
has VBZ O
the DT O
ability NN O
to TO O
automatically RB O
down RB O
select VB B-Action
the DT B-Entity
most RBS I-Entity
effective JJ I-Entity
communication NN I-Entity
channel NN I-Entity
once IN B-Modifier
it PRP B-Entity
has VBZ I-Entity
been VBN I-Entity
instantiated VBN I-Entity
, , O
which WDT O
can MD O
help VB O
avoid VB B-Action
detection NN B-Entity
from IN I-Entity
solutions NNS I-Entity
like IN I-Entity
DNS NN I-Entity
blacklisting NN I-Entity
and CC I-Entity
RFC NN I-Entity
protocol NN I-Entity
enforcement NN I-Entity
. . O

The DT O
DLL NNP O
itself PRP O
contains VBZ O
traces NNS O
of IN O
the DT O
original JJ O
C++ NNP O
class NN O
names NNS O
that WDT O
were VBD O
utilized VBN O
in IN O
the DT O
source NN O
code NN O
, , O
which WDT O
in IN O
general JJ O
were VBD O
prefixed VBN O
with IN O
'PCC NN O
' '' O
. . O

The DT B-Entity
sample NN I-Entity
supports VBZ O
the DT O
ability NN O
to TO O
act VB B-Action
as IN B-Modifier
a DT B-Entity
generic JJ I-Entity
proxy NN I-Entity
, , O
this DT O
may MD O
be VB O
intended VBN O
to TO O
proxy NN B-Action
C2 NN B-Entity
traffic NN I-Entity
for IN B-Modifier
other JJ B-Entity
infected JJ I-Entity
machines NNS I-Entity
in IN B-Modifier
order NN I-Modifier
to TO I-Modifier
minimize VB B-Entity
the DT I-Entity
number NN I-Entity
of IN I-Entity
systems NNS I-Entity
communicating VBG I-Entity
to TO I-Entity
the DT I-Entity
C2 NN I-Entity
, , O
thus RB O
enhancing VBG O
OPSEC NNP O
. . O

The DT O
sample NN O
contains VBZ O
'dead NN O
code NN O
' '' O
which WDT O
appears VBZ O
to TO O
be VB O
command NN O
and CC O
control NN O
server NN O
classes NNS O
, , O
this DT O
is VBZ O
likely RB O
an DT O
indicator NN O
that IN O
the DT B-Entity
C2 NN I-Entity
client NN I-Entity
which WDT I-Entity
would MD I-Entity
communicate VB I-Entity
with IN I-Entity
this DT I-Entity
sample NN I-Entity
shares VBZ B-Action
the DT B-Entity
same JJ I-Entity
communications NNS I-Entity
library NN I-Entity
which WDT I-Entity
was VBD I-Entity
compiled VBN I-Entity
into IN I-Entity
this DT I-Entity
sample NN I-Entity
. . O

The DT B-Entity
kernel NN I-Entity
driver NN I-Entity
component NN I-Entity
dropped VBN B-Action
by IN O
the DT B-Entity
Backdoor NNP I-Entity
DLL NNP I-Entity
bears VBZ O
many JJ O
tool NN O
marks NNS O
associating VBG O
it PRP O
with IN O
the DT O
CCRootkit NN O
package NN O
publicly RB O
by IN O
Steven NNP O
Lai NNP O
( NNP O
a/k/a IN O
embedlinux FW O
) FW O
. . O

This DT B-Entity
kernel NN I-Entity
mode NN I-Entity
rootkit NN I-Entity
implements VBZ B-Action
several JJ B-Entity
hooking VBG I-Entity
techniques NNS I-Entity
that WDT O
are VBP O
aimed VBN O
at IN O
preventing VBG B-Action
a DT B-Entity
system NN I-Entity
administrator NN I-Entity
from IN B-Modifier
detecting VBG B-Entity
the DT I-Entity
backdoor JJ I-Entity
DLL NNP I-Entity
. . O

The DT O
implementation NN O
of IN O
these DT O
techniques NNS O
has VBZ O
some DT O
unique JJ O
idiosyncrasies NNS O
that WDT O
permit VBP O
direct JJ O
attribution NN O
to TO O
the DT O
source NN O
code NN O
Steven NNP O
Lai NNP O
posted VBD O
. . O

This DT B-Entity
driver NN I-Entity
attempts VBZ O
to TO O
hide VB B-Action
a DT B-Entity
wide JJ I-Entity
swath NN I-Entity
of IN I-Entity
TCP NN I-Entity
ports NNS I-Entity
( VBP I-Entity
40000-45000 CD I-Entity
) NN I-Entity
for IN B-Modifier
an DT B-Entity
unknown JJ I-Entity
reason NN I-Entity
, , O
however RB O
it PRP O
is VBZ O
suspected VBN O
that IN O
this DT O
may MD O
relate VB O
to TO O
the DT O
potential JJ O
network NN O
relaying VBG O
capability NN O
alluded VBD O
to TO O
for IN O
the DT O
backdoor JJ O
dll NN O
. . O

The DT B-Entity
kernel NN I-Entity
driver NN I-Entity
component NN I-Entity
dropped VBN B-Action
by IN O
the DT B-Entity
Backdoor NNP I-Entity
DLL NNP I-Entity
bears VBZ O
many JJ O
tool NN O
marks NNS O
associating VBG O
it PRP O
with IN O
the DT O
CCRootkit NN O
package NN O
publicly RB O
by IN O
Steven NNP O
Lai NNP O
( NNP O
a/k/a IN O
embedlinux FW O
) FW O
. . O

This DT B-Entity
kernel NN I-Entity
mode NN I-Entity
rootkit NN I-Entity
implements VBZ B-Action
several JJ B-Entity
hooking VBG I-Entity
techniques NNS I-Entity
that WDT O
are VBP O
aimed VBN O
at IN O
preventing VBG B-Action
a DT B-Entity
system NN I-Entity
administrator NN I-Entity
from IN B-Modifier
detecting VBG B-Entity
the DT I-Entity
backdoor JJ I-Entity
DLL NNP I-Entity
. . O

The DT O
implementation NN O
of IN O
these DT O
techniques NNS O
has VBZ O
some DT O
unique JJ O
idiosyncrasies NNS O
that WDT O
permit VBP O
direct JJ O
attribution NN O
to TO O
the DT O
source NN O
code NN O
Steven NNP O
Lai NNP O
posted VBD O
. . O

This DT B-Entity
driver NN I-Entity
attempts VBZ O
to TO O
hide VB B-Action
a DT B-Entity
wide JJ I-Entity
swath NN I-Entity
of IN I-Entity
TCP NN I-Entity
ports NNS I-Entity
( VBP I-Entity
40000-45000 CD I-Entity
) NN I-Entity
for IN B-Modifier
an DT B-Entity
unknown JJ I-Entity
reason NN I-Entity
, , O
however RB O
it PRP O
is VBZ O
suspected VBN O
that IN O
this DT O
may MD O
relate VB O
to TO O
the DT O
potential JJ O
network NN O
relaying VBG O
capability NN O
alluded VBD O
to TO O
for IN O
the DT O
backdoor JJ O
dll NN O
. . O

Implemented VBN O
values NNS O
for IN O
cmdID NN O
are VBP O
as IN O
follows VBZ O
: : O
cmdType NN O
can MD O
be VB O
one CD O
of IN O
the DT O
following VBG O
( NNP O
Interesting NNP O
commands NNS O
explained VBD O
in IN O
detail NN O
) NN O
: : O
string0 NN O
can MD O
have VB O
one CD O
of IN O
the DT O
following JJ O
values NNS O
dependant JJ O
upon IN O
command NN O
id NN O
and CC O
type NN O
. . O

cardmagic JJ O
writes VBZ O
: : O
Windows NNP O
Vista NNP O
has VBZ O
changed VBN O
alot NN O
on IN O
network NN O
module NN O
, , O
many JJ O
old JJ O
port NN O
hiding NN O
materials NNS O
are VBP O
no RB O
longer RB O
usable JJ O
. . O

In IN O
this DT O
post NN O
, , O
I PRP O
will MD O
share VB O
with IN O
you PRP O
a DT O
simple JJ O
code NN O
to TO O
hide VB O
port NN O
under IN O
Vista NNP O
, , O
hope VBP O
it PRP O
is VBZ O
useful JJ O
for IN O
some DT O
guys NNS O
. . O

Actually RB O
under IN O
Windows NNP O
Vista NNP O
, , O
netstat.exe NNP O
will MD O
call VB O
InternalGetTcpTable2 NN O
which WDT O
is VBZ O
exported VBN O
by IN O
Iphlpapi.dll NN O
to TO O
list VB O
all DT O
open JJ O
ports NNS O
, , O
then RB O
InternalGetTcpTable2 NN O
will MD O
transfer VB O
control NN O
to TO O
NsiAllocateAndGetTable NNP O
which WDT O
is VBZ O
exported VBN O
by IN O
nsi.dll NN O
, , O
and CC O
finally RB O
nsi.dll NN O
involve VBP O
NsiEnumerateObjectsAllParametersEx NN O
to TO O
interact VB O
with IN O
kernel NN O
mode NN O
module NN O
of IN O
NSI NNP O
-- : O
nsiproxy.sys NNS O
. . O

nsiproxy.sys NNS O
is VBZ O
almost RB O
like IN O
a DT O
wrapper NN O
of IN O
netio.sys NNS O
, , O
it PRP O
will MD O
then RB O
call VB O
internal JJ O
subroutines NNS O
of IN O
netio.sys NNS O
. . O

Here RB O
, , O
we PRP O
will MD O
use VB O
a DT O
relatively RB O
easy JJ O
way NN O
-- : O
'' '' O
NSI NNP O
Kernel NNP O
Module NNP O
Dispatch NNP O
Routine NNP O
Hook NNP O
'' '' O
to TO O
demonstrate VB O
the DT O
specified VBN O
port NN O
hiding VBG O
uner JJ O
Vista NNP O
. . O

Dispatch VB O
routine JJ O
hook NN O
is VBZ O
an DT O
old JJ O
topic NN O
, , O
this DT O
time NN O
, , O
we PRP O
will MD O
apply VB O
this DT O
method NN O
to TO O
nsiproxy.sys NNS O
. . O

Please VB O
focus NN O
on IN O
how WRB O
to TO O
handle VB O
the DT O
content NN O
filtering VBG O
of IN O
NSI NNP O
: : O
) CD O
Check VB O
the DT O
following JJ O
code NN O
( NNP O
Notice NNP O
: : O
I PRP O
only RB O
tested VBD O
it PRP O
under IN O
Windows NNP O
Vista NNP O
RTM NNP O
32bit NNP O
) NNP O
: : O
